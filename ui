local Players          = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService     = game:GetService("TweenService")

local Player    = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

if PlayerGui:FindFirstChild("__UILib") then
    PlayerGui:FindFirstChild("__UILib"):Destroy()
end

local ScreenGui          = Instance.new("ScreenGui")
ScreenGui.Name           = "__UILib"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn   = false
ScreenGui.Parent         = PlayerGui

local THEMES = {
    Default = {
        ACCENT      = Color3.fromRGB(99,  102, 241),
        ACCENT_DARK = Color3.fromRGB(67,   70, 180),
        BG_MAIN     = Color3.fromRGB(12,   12,  16),
        BG_PANEL    = Color3.fromRGB(18,   18,  24),
        BG_SIDEBAR  = Color3.fromRGB(14,   14,  20),
        BG_ELEMENT  = Color3.fromRGB(26,   26,  36),
        BG_HOVER    = Color3.fromRGB(34,   34,  48),
        TEXT_MAIN   = Color3.fromRGB(230, 230, 240),
        TEXT_DIM    = Color3.fromRGB(110, 110, 140),
        GREEN       = Color3.fromRGB(52,  211, 153),
        RED         = Color3.fromRGB(239,  68,  68),
    },
    Light = {
        ACCENT      = Color3.fromRGB(99,  102, 241),
        ACCENT_DARK = Color3.fromRGB(67,   70, 180),
        BG_MAIN     = Color3.fromRGB(240, 240, 248),
        BG_PANEL    = Color3.fromRGB(225, 225, 238),
        BG_SIDEBAR  = Color3.fromRGB(230, 230, 244),
        BG_ELEMENT  = Color3.fromRGB(210, 210, 228),
        BG_HOVER    = Color3.fromRGB(198, 198, 220),
        TEXT_MAIN   = Color3.fromRGB(20,   20,  40),
        TEXT_DIM    = Color3.fromRGB(100, 100, 130),
        GREEN       = Color3.fromRGB(30,  160, 100),
        RED         = Color3.fromRGB(200,  50,  50),
    },
    Midnight = {
        ACCENT      = Color3.fromRGB(56,  189, 248),
        ACCENT_DARK = Color3.fromRGB(14,  165, 233),
        BG_MAIN     = Color3.fromRGB(2,    6,  23),
        BG_PANEL    = Color3.fromRGB(6,   12,  34),
        BG_SIDEBAR  = Color3.fromRGB(4,    9,  28),
        BG_ELEMENT  = Color3.fromRGB(10,  20,  50),
        BG_HOVER    = Color3.fromRGB(16,  30,  68),
        TEXT_MAIN   = Color3.fromRGB(224, 242, 254),
        TEXT_DIM    = Color3.fromRGB(100, 140, 180),
        GREEN       = Color3.fromRGB(52,  211, 153),
        RED         = Color3.fromRGB(239,  68,  68),
    },
    Rose = {
        ACCENT      = Color3.fromRGB(244, 114, 182),
        ACCENT_DARK = Color3.fromRGB(219,  39, 119),
        BG_MAIN     = Color3.fromRGB(15,   10,  14),
        BG_PANEL    = Color3.fromRGB(24,   16,  22),
        BG_SIDEBAR  = Color3.fromRGB(18,   12,  17),
        BG_ELEMENT  = Color3.fromRGB(36,   24,  34),
        BG_HOVER    = Color3.fromRGB(48,   32,  46),
        TEXT_MAIN   = Color3.fromRGB(255, 228, 245),
        TEXT_DIM    = Color3.fromRGB(160, 110, 145),
        GREEN       = Color3.fromRGB(52,  211, 153),
        RED         = Color3.fromRGB(239,  68,  68),
    },
}

-- ============================================================
-- THEME PERSISTENCE  (saves to workspace/L Hub/Theme)
-- ============================================================
local THEME_SAVE_PATH = "L Hub/Theme"

-- Serialize a theme table â†’ plain text  "KEY=R,G,B\n..."
local function SerializeTheme(t)
    local lines = {}
    for k, v in pairs(t) do
        local r = math.floor(v.R * 255 + 0.5)
        local g = math.floor(v.G * 255 + 0.5)
        local b = math.floor(v.B * 255 + 0.5)
        table.insert(lines, k .. "=" .. r .. "," .. g .. "," .. b)
    end
    table.sort(lines)
    return table.concat(lines, "\n")
end

-- Deserialize saved text â†’ theme table (merges with Default for any missing keys)
local function DeserializeTheme(text)
    local t = {}
    for k, v in pairs(THEMES.Default) do t[k] = v end  -- fallback defaults
    for line in text:gmatch("[^\n]+") do
        local key, r, g, b = line:match("^(%w+)=(%d+),(%d+),(%d+)$")
        if key and r then
            t[key] = Color3.fromRGB(tonumber(r), tonumber(g), tonumber(b))
        end
    end
    return t
end

local function SaveTheme(t)
    pcall(function()
        -- Make sure the folder exists (writefile creates parent dirs on most executors)
        if not isfolder("L Hub") then makefolder("L Hub") end
        writefile(THEME_SAVE_PATH, SerializeTheme(t))
    end)
end

local function LoadSavedTheme()
    -- Returns a theme table if a save file exists, otherwise nil
    local ok, data = pcall(readfile, THEME_SAVE_PATH)
    if ok and type(data) == "string" and #data > 0 then
        return DeserializeTheme(data)
    end
    return nil
end

-- Try to load saved theme; fall back to Default
local saved = LoadSavedTheme()
local T = saved and saved or THEMES.Default

-- If we loaded a custom saved theme, register it so ApplyTheme can reference it
if saved then
    THEMES["_Saved"] = saved
end

local MIN_W, MIN_H         = 480, 320
local DEFAULT_W, DEFAULT_H = 620, 420
local CORNER_R             = 12

local function Corner(parent, radius)
    local c = Instance.new("UICorner")
    c.CornerRadius = radius or UDim.new(0, 8)
    c.Parent = parent
    return c
end

local function Stroke(parent, color, thickness)
    local s = Instance.new("UIStroke")
    s.Color     = color     or Color3.fromRGB(40, 40, 60)
    s.Thickness = thickness or 1
    s.Parent    = parent
    return s
end

local function Tween(obj, props, t, style, dir)
    TweenService:Create(obj,
        TweenInfo.new(t or 0.18, style or Enum.EasingStyle.Quart, dir or Enum.EasingDirection.Out),
        props
    ):Play()
end

local function HoverEffect(btn, normalFn, hoverFn)
    btn.MouseEnter:Connect(function() Tween(btn, {BackgroundColor3 = hoverFn()},   0.12) end)
    btn.MouseLeave:Connect(function() Tween(btn, {BackgroundColor3 = normalFn()},  0.15) end)
end

local function FadeOut(cg, duration, callback)
    Tween(cg, {GroupTransparency = 1}, duration or 0.18)
    if callback then task.delay((duration or 0.18) + 0.02, callback) end
end

local function FadeIn(cg, duration)
    cg.GroupTransparency = 1
    cg.Visible           = true
    Tween(cg, {GroupTransparency = 0}, duration or 0.2)
end

local themeListeners = {}
local function OnThemeChange(fn)
    table.insert(themeListeners, fn)
end
local function ApplyTheme(name)
    if not THEMES[name] then return end
    T = THEMES[name]
    for _, fn in ipairs(themeListeners) do
        pcall(fn, T)
    end
    SaveTheme(T)
end

local scaleListeners = {}
local function OnScaleChange(fn)
    table.insert(scaleListeners, fn)
end

local currentScale = 1.0
local function ApplyScale(s)
    currentScale = s
    for _, fn in ipairs(scaleListeners) do
        pcall(fn, s)
    end
end

local OpenButton            = Instance.new("TextButton")
OpenButton.Size             = UDim2.new(0, 60, 0, 32)
OpenButton.Position         = UDim2.new(0, 20, 0.5, -16)
OpenButton.BackgroundColor3 = T.ACCENT
OpenButton.Text             = "UI"
OpenButton.TextColor3       = Color3.new(1, 1, 1)
OpenButton.Font             = Enum.Font.GothamBold
OpenButton.TextSize         = 12
OpenButton.Visible          = false
OpenButton.ZIndex           = 10
OpenButton.Parent           = ScreenGui
Corner(OpenButton, UDim.new(1, 0))
Stroke(OpenButton, Color3.fromRGB(120, 120, 255), 1)

OnThemeChange(function(theme)
    OpenButton.BackgroundColor3 = theme.ACCENT
end)

do
    local drag, dragStart, startPos, moved = false, nil, nil, false
    OpenButton.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            drag = true; moved = false; dragStart = i.Position; startPos = OpenButton.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(i)
        if drag and i.UserInputType == Enum.UserInputType.MouseMovement then
            local d = i.Position - dragStart
            if d.Magnitude > 4 then moved = true end
            OpenButton.Position = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + d.X,
                startPos.Y.Scale, startPos.Y.Offset + d.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then drag = false end
    end)
    OpenButton.MouseButton1Click:Connect(function()
        if not moved then
            OpenButton.Visible = false
            local cg = ScreenGui:FindFirstChild("MainGroup")
            if cg then FadeIn(cg, 0.2) end
        end
    end)
end

local MainGroup                  = Instance.new("CanvasGroup")
MainGroup.Name                   = "MainGroup"
MainGroup.Size                   = UDim2.new(0, DEFAULT_W, 0, DEFAULT_H)
MainGroup.Position               = UDim2.new(0.5, -DEFAULT_W/2, 0.5, -DEFAULT_H/2)
MainGroup.BackgroundTransparency = 1
MainGroup.BorderSizePixel        = 0
MainGroup.ZIndex                 = 1
MainGroup.Parent                 = ScreenGui

local MainFrame               = Instance.new("Frame")
MainFrame.Name                = "MainFrame"
MainFrame.Size                = UDim2.new(1, 0, 1, 0)
MainFrame.BackgroundColor3    = T.BG_MAIN
MainFrame.BorderSizePixel     = 0
MainFrame.ClipsDescendants    = false
MainFrame.Parent              = MainGroup
Corner(MainFrame, UDim.new(0, CORNER_R))
local MainStroke = Stroke(MainFrame, Color3.fromRGB(45, 45, 70), 1.5)

OnThemeChange(function(theme)
    MainFrame.BackgroundColor3 = theme.BG_MAIN
end)

local Gradient      = Instance.new("UIGradient")
Gradient.Rotation   = 135
Gradient.Parent     = MainFrame

local function UpdateGradient()
    Gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(
            math.clamp(T.BG_MAIN.R * 255 + 13, 0, 255),
            math.clamp(T.BG_MAIN.G * 255 + 13, 0, 255),
            math.clamp(T.BG_MAIN.B * 255 + 24, 0, 255)
        )),
        ColorSequenceKeypoint.new(1, T.BG_MAIN),
    })
end
UpdateGradient()
OnThemeChange(function() UpdateGradient() end)

local TitleBar              = Instance.new("Frame")
TitleBar.Size               = UDim2.new(1, 0, 0, 44)
TitleBar.BackgroundColor3   = T.BG_PANEL
TitleBar.BorderSizePixel    = 0
TitleBar.ZIndex             = 3
TitleBar.Parent             = MainFrame
Corner(TitleBar, UDim.new(0, CORNER_R))

OnThemeChange(function(theme) TitleBar.BackgroundColor3 = theme.BG_PANEL end)

local TBarBotMask             = Instance.new("Frame")
TBarBotMask.Size              = UDim2.new(1, 0, 0, CORNER_R)
TBarBotMask.Position          = UDim2.new(0, 0, 1, -CORNER_R)
TBarBotMask.BackgroundColor3  = T.BG_PANEL
TBarBotMask.BorderSizePixel   = 0
TBarBotMask.ZIndex            = 3
TBarBotMask.Parent            = TitleBar
OnThemeChange(function(theme) TBarBotMask.BackgroundColor3 = theme.BG_PANEL end)

local LogoDot             = Instance.new("Frame")
LogoDot.Size              = UDim2.new(0, 8, 0, 8)
LogoDot.Position          = UDim2.new(0, 14, 0.5, -4)
LogoDot.BackgroundColor3  = T.ACCENT
LogoDot.ZIndex            = 5
LogoDot.Parent            = TitleBar
Corner(LogoDot, UDim.new(1, 0))
OnThemeChange(function(theme) LogoDot.BackgroundColor3 = theme.ACCENT end)

local TitleLabel              = Instance.new("TextLabel")
TitleLabel.Size               = UDim2.new(0, 200, 1, 0)
TitleLabel.Position           = UDim2.new(0, 30, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text               = "UI"
TitleLabel.TextColor3         = T.TEXT_MAIN
TitleLabel.Font               = Enum.Font.GothamBold
TitleLabel.TextSize           = 14
TitleLabel.TextXAlignment     = Enum.TextXAlignment.Left
TitleLabel.ZIndex             = 5
TitleLabel.Parent             = TitleBar
OnThemeChange(function(theme) TitleLabel.TextColor3 = theme.TEXT_MAIN end)

local function MakeWindowBtn(xOffset, bgColor, symbol, hoverColor)
    local btn               = Instance.new("TextButton")
    btn.Size                = UDim2.new(0, 28, 0, 28)
    btn.Position            = UDim2.new(1, xOffset, 0.5, -14)
    btn.BackgroundColor3    = bgColor
    btn.Text                = symbol
    btn.TextColor3          = Color3.new(1, 1, 1)
    btn.Font                = Enum.Font.GothamBold
    btn.TextSize            = 11
    btn.ZIndex              = 6
    btn.Parent              = TitleBar
    Corner(btn, UDim.new(0, 6))
    return btn
end

local CloseBtn   = MakeWindowBtn(-38, Color3.fromRGB(200, 60, 60), "X", Color3.fromRGB(240, 80, 80))
local MiniBtn    = MakeWindowBtn(-72, Color3.fromRGB(40, 40, 60),  "-", Color3.fromRGB(55, 55, 80))
local ThemeTitleBtn = MakeWindowBtn(-108, Color3.fromRGB(40, 40, 60), "ðŸŽ¨", Color3.fromRGB(55, 55, 80))

OnThemeChange(function(theme)
    MiniBtn.BackgroundColor3       = theme.BG_ELEMENT
    ThemeTitleBtn.BackgroundColor3 = theme.BG_ELEMENT
end)

-- ============================================================
-- INLINE SEARCH BOX IN TITLEBAR
-- ============================================================
local TitleSearchBox              = Instance.new("TextBox")
-- Search stretches from after the title/version area to just before THM button
-- Title dot+label ~ 30px, version badge ~ 210px end. Right buttons: X(-38) Mini(-72) THM(-108) â†’ rightmost at -120
-- So search goes from ~210 offset left to -122 right edge = lots of room
TitleSearchBox.Size               = UDim2.new(1, -340, 0, 26)
TitleSearchBox.Position           = UDim2.new(0, 210, 0.5, -13)
TitleSearchBox.BackgroundColor3   = T.BG_ELEMENT
TitleSearchBox.PlaceholderText    = "Search..."
TitleSearchBox.PlaceholderColor3  = T.TEXT_DIM
TitleSearchBox.Text               = ""
TitleSearchBox.TextColor3         = T.TEXT_MAIN
TitleSearchBox.Font               = Enum.Font.Gotham
TitleSearchBox.TextSize           = 12
TitleSearchBox.ClearTextOnFocus   = false
TitleSearchBox.ZIndex             = 6
TitleSearchBox.Parent             = TitleBar
Corner(TitleSearchBox, UDim.new(0, 6))
Stroke(TitleSearchBox, Color3.fromRGB(55, 55, 90), 1)
OnThemeChange(function(theme)
    TitleSearchBox.BackgroundColor3 = theme.BG_ELEMENT
    TitleSearchBox.TextColor3       = theme.TEXT_MAIN
    TitleSearchBox.PlaceholderColor3= theme.TEXT_DIM
end)
local TSBPad            = Instance.new("UIPadding")
TSBPad.PaddingLeft      = UDim.new(0, 8)
TSBPad.Parent           = TitleSearchBox

do
    local dragging, dragStart, startPos = false, nil, nil
    TitleBar.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true; dragStart = i.Position; startPos = MainGroup.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(i)
        if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
            local d = i.Position - dragStart
            MainGroup.Position = UDim2.new(
                startPos.X.Scale, startPos.X.Offset + d.X,
                startPos.Y.Scale, startPos.Y.Offset + d.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)
end

local ResizeHandle            = Instance.new("TextButton")
ResizeHandle.Size             = UDim2.new(0, 22, 0, 22)
ResizeHandle.Position         = UDim2.new(1, -22, 1, -22)
ResizeHandle.BackgroundColor3 = Color3.fromRGB(40, 40, 65)
ResizeHandle.Text             = ""
ResizeHandle.ZIndex           = 10
ResizeHandle.Parent           = MainFrame
Corner(ResizeHandle, UDim.new(0, 6))

for r = 0, 2 do
    for c = 0, 2 do
        if r + c >= 2 then
            local dot             = Instance.new("Frame")
            dot.Size              = UDim2.new(0, 2, 0, 2)
            dot.Position          = UDim2.new(0, 4 + c * 5, 0, 4 + r * 5)
            dot.BackgroundColor3  = T.TEXT_DIM
            dot.BorderSizePixel   = 0
            dot.ZIndex            = 11
            dot.Parent            = ResizeHandle
            Corner(dot, UDim.new(1, 0))
            OnThemeChange(function(theme) dot.BackgroundColor3 = theme.TEXT_DIM end)
        end
    end
end

do
    local resizing, resizeStart, startSize = false, nil, nil
    ResizeHandle.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then
            resizing = true; resizeStart = i.Position; startSize = MainGroup.Size
        end
    end)
    UserInputService.InputChanged:Connect(function(i)
        if resizing and i.UserInputType == Enum.UserInputType.MouseMovement then
            local d = i.Position - resizeStart
            local newW = math.max(MIN_W, startSize.X.Offset + d.X)
            local newH = math.max(MIN_H, startSize.Y.Offset + d.Y)
            MainGroup.Size = UDim2.new(0, newW, 0, newH)
            local scaleW = newW / DEFAULT_W
            local scaleH = newH / DEFAULT_H
            local s = math.min(scaleW, scaleH)
            ApplyScale(s)
        end
    end)
    UserInputService.InputEnded:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then resizing = false end
    end)
end

local Sidebar               = Instance.new("Frame")
Sidebar.Size                = UDim2.new(0, 155, 1, -44)
Sidebar.Position            = UDim2.new(0, 0, 0, 44)
Sidebar.BackgroundColor3    = T.BG_SIDEBAR
Sidebar.BorderSizePixel     = 0
Sidebar.ZIndex              = 2
Sidebar.Parent              = MainFrame
Corner(Sidebar, UDim.new(0, CORNER_R))
OnThemeChange(function(theme) Sidebar.BackgroundColor3 = theme.BG_SIDEBAR end)

local SB_TopMask            = Instance.new("Frame")
SB_TopMask.Size             = UDim2.new(1, 0, 0, CORNER_R)
SB_TopMask.BackgroundColor3 = T.BG_SIDEBAR
SB_TopMask.BorderSizePixel  = 0
SB_TopMask.ZIndex           = 2
SB_TopMask.Parent           = Sidebar
OnThemeChange(function(theme) SB_TopMask.BackgroundColor3 = theme.BG_SIDEBAR end)

local SB_RightMask            = Instance.new("Frame")
SB_RightMask.Size             = UDim2.new(0, CORNER_R, 1, 0)
SB_RightMask.Position         = UDim2.new(1, -CORNER_R, 0, 0)
SB_RightMask.BackgroundColor3 = T.BG_SIDEBAR
SB_RightMask.BorderSizePixel  = 0
SB_RightMask.ZIndex           = 2
SB_RightMask.Parent           = Sidebar
OnThemeChange(function(theme) SB_RightMask.BackgroundColor3 = theme.BG_SIDEBAR end)

local SidebarBorder             = Instance.new("Frame")
SidebarBorder.Size              = UDim2.new(0, 1, 1, 0)
SidebarBorder.Position          = UDim2.new(1, -1, 0, 0)
SidebarBorder.BackgroundColor3  = Color3.fromRGB(38, 38, 60)
SidebarBorder.BorderSizePixel   = 0
SidebarBorder.ZIndex            = 3
SidebarBorder.Parent            = Sidebar

local TabContainer              = Instance.new("ScrollingFrame")
TabContainer.Size               = UDim2.new(1, 0, 1, -10)
TabContainer.Position           = UDim2.new(0, 0, 0, 10)
TabContainer.BackgroundTransparency = 1
TabContainer.ScrollBarThickness = 0
TabContainer.ZIndex             = 4
TabContainer.Parent             = Sidebar

local TabLayout                 = Instance.new("UIListLayout")
TabLayout.Parent                = TabContainer
TabLayout.HorizontalAlignment   = Enum.HorizontalAlignment.Center
TabLayout.Padding               = UDim.new(0, 4)

local ContentClip               = Instance.new("Frame")
ContentClip.Size                = UDim2.new(1, -155, 1, -68)
ContentClip.Position            = UDim2.new(0, 155, 0, 44)
ContentClip.BackgroundTransparency = 1
ContentClip.ClipsDescendants    = true
ContentClip.ZIndex              = 2
ContentClip.Parent              = MainFrame

local ContentArea               = Instance.new("Frame")
ContentArea.Size                = UDim2.new(1, 0, 1, 0)
ContentArea.BackgroundTransparency = 1
ContentArea.ZIndex              = 2
ContentArea.Parent              = ContentClip

local StatusBar               = Instance.new("Frame")
StatusBar.Size                = UDim2.new(1, -155, 0, 24)
StatusBar.Position            = UDim2.new(0, 155, 1, -24)
StatusBar.BackgroundColor3    = T.BG_PANEL
StatusBar.BorderSizePixel     = 0
StatusBar.ZIndex              = 3
StatusBar.Parent              = MainFrame
Corner(StatusBar, UDim.new(0, CORNER_R))
OnThemeChange(function(theme) StatusBar.BackgroundColor3 = theme.BG_PANEL end)

local SB2_TopMask             = Instance.new("Frame")
SB2_TopMask.Size              = UDim2.new(1, 0, 0, CORNER_R)
SB2_TopMask.BackgroundColor3  = T.BG_PANEL
SB2_TopMask.BorderSizePixel   = 0
SB2_TopMask.ZIndex            = 3
SB2_TopMask.Parent            = StatusBar
OnThemeChange(function(theme) SB2_TopMask.BackgroundColor3 = theme.BG_PANEL end)

local SB2_LeftMask            = Instance.new("Frame")
SB2_LeftMask.Size             = UDim2.new(0, CORNER_R, 1, 0)
SB2_LeftMask.BackgroundColor3 = T.BG_PANEL
SB2_LeftMask.BorderSizePixel  = 0
SB2_LeftMask.ZIndex           = 3
SB2_LeftMask.Parent           = StatusBar
OnThemeChange(function(theme) SB2_LeftMask.BackgroundColor3 = theme.BG_PANEL end)

local StatusBorderTop           = Instance.new("Frame")
StatusBorderTop.Size            = UDim2.new(1, 0, 0, 1)
StatusBorderTop.BackgroundColor3= Color3.fromRGB(38, 38, 60)
StatusBorderTop.BorderSizePixel = 0
StatusBorderTop.ZIndex          = 4
StatusBorderTop.Parent          = StatusBar

local StatusText              = Instance.new("TextLabel")
StatusText.Size               = UDim2.new(1, -10, 1, 0)
StatusText.Position           = UDim2.new(0, 10, 0, 0)
StatusText.BackgroundTransparency = 1
StatusText.Text               = "Ready"
StatusText.TextColor3         = T.GREEN
StatusText.Font               = Enum.Font.Gotham
StatusText.TextSize           = 10
StatusText.TextXAlignment     = Enum.TextXAlignment.Left
StatusText.ZIndex             = 5
StatusText.Parent             = StatusBar
OnThemeChange(function(theme) StatusText.TextColor3 = theme.GREEN end)

local function SetStatus(text, color)
    StatusText.Text       = text
    StatusText.TextColor3 = color or T.GREEN
end

CloseBtn.MouseButton1Click:Connect(function()
    FadeOut(MainGroup, 0.18, function() ScreenGui:Destroy() end)
end)

MiniBtn.MouseButton1Click:Connect(function()
    FadeOut(MainGroup, 0.15, function()
        MainGroup.Visible  = false
        OpenButton.Visible = true
    end)
end)

-- ============================================================
-- FONT SCALE (no settings popup - use Library API instead)
-- ============================================================
local currentFontScale = 1.0
local fontScaleListeners = {}
local function OnFontScaleChange(fn) table.insert(fontScaleListeners, fn) end
local function ApplyFontScale(s)
    currentFontScale = s
    for _, fn in ipairs(fontScaleListeners) do pcall(fn, s) end
end

-- ============================================================
-- INLINE SEARCH DROPDOWN (attached to titlebar search box)
-- ============================================================
local allSearchItems = {}

-- Dropdown panel that appears below the titlebar search box
local SearchDropdown              = Instance.new("Frame")
SearchDropdown.Name               = "SearchDropdown"
SearchDropdown.Size               = UDim2.new(0, 260, 0, 0)
SearchDropdown.Position           = UDim2.new(1, -264, 1, 4)
SearchDropdown.BackgroundColor3   = T.BG_PANEL
SearchDropdown.BorderSizePixel    = 0
SearchDropdown.Visible            = false
SearchDropdown.ZIndex             = 60
SearchDropdown.ClipsDescendants   = true
SearchDropdown.Parent             = TitleBar
Corner(SearchDropdown, UDim.new(0, 8))
Stroke(SearchDropdown, Color3.fromRGB(55, 55, 80), 1)
OnThemeChange(function(theme) SearchDropdown.BackgroundColor3 = theme.BG_PANEL end)

local SearchResults               = Instance.new("ScrollingFrame")
SearchResults.Size                = UDim2.new(1, -8, 1, -8)
SearchResults.Position            = UDim2.new(0, 4, 0, 4)
SearchResults.BackgroundTransparency = 1
SearchResults.ScrollBarThickness  = 3
SearchResults.ScrollBarImageColor3= T.ACCENT
SearchResults.CanvasSize          = UDim2.new(0, 0, 0, 0)
SearchResults.ZIndex              = 61
SearchResults.Parent              = SearchDropdown
OnThemeChange(function(theme) SearchResults.ScrollBarImageColor3 = theme.ACCENT end)

local SRLayout                    = Instance.new("UIListLayout")
SRLayout.Padding                  = UDim.new(0, 4)
SRLayout.Parent                   = SearchResults
SRLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    local h = math.min(SRLayout.AbsoluteContentSize.Y + 10, 220)
    SearchDropdown.Size = UDim2.new(0, 260, 0, h)
    SearchResults.CanvasSize = UDim2.new(0, 0, 0, SRLayout.AbsoluteContentSize.Y + 10)
end)

local function RebuildSearch(query)
    for _, c in ipairs(SearchResults:GetChildren()) do
        if not c:IsA("UIListLayout") then c:Destroy() end
    end
    local q = query:lower()
    local count = 0
    for _, item in ipairs(allSearchItems) do
        if q == "" or item.title:lower():find(q, 1, true) then
            count += 1
            local row               = Instance.new("TextButton")
            row.Size                = UDim2.new(1, 0, 0, 34)
            row.BackgroundColor3    = T.BG_ELEMENT
            row.Text                = ""
            row.ZIndex              = 62
            row.Parent              = SearchResults
            Corner(row, UDim.new(0, 6))
            Stroke(row, Color3.fromRGB(38, 38, 60), 1)
            OnThemeChange(function(theme) row.BackgroundColor3 = theme.BG_ELEMENT end)

            local nameL             = Instance.new("TextLabel")
            nameL.Size              = UDim2.new(1, -80, 1, 0)
            nameL.Position          = UDim2.new(0, 10, 0, 0)
            nameL.BackgroundTransparency = 1
            nameL.Text              = item.title
            nameL.TextColor3        = T.TEXT_MAIN
            nameL.Font              = Enum.Font.Gotham
            nameL.TextSize          = 12
            nameL.TextXAlignment    = Enum.TextXAlignment.Left
            nameL.ZIndex            = 63
            nameL.Parent            = row
            OnThemeChange(function(theme) nameL.TextColor3 = theme.TEXT_MAIN end)

            local tagL              = Instance.new("TextLabel")
            tagL.Size               = UDim2.new(0, 64, 0, 18)
            tagL.Position           = UDim2.new(1, -70, 0.5, -9)
            tagL.BackgroundColor3   = T.BG_MAIN
            tagL.Text               = item.kind
            tagL.TextColor3         = T.ACCENT
            tagL.Font               = Enum.Font.GothamBold
            tagL.TextSize           = 9
            tagL.ZIndex             = 63
            tagL.Parent             = row
            Corner(tagL, UDim.new(0, 4))
            OnThemeChange(function(theme)
                tagL.BackgroundColor3 = theme.BG_MAIN
                tagL.TextColor3       = theme.ACCENT
            end)

            row.MouseEnter:Connect(function() Tween(row, {BackgroundColor3 = T.BG_HOVER}, 0.12) end)
            row.MouseLeave:Connect(function() Tween(row, {BackgroundColor3 = T.BG_ELEMENT}, 0.15) end)
            row.MouseButton1Click:Connect(function()
                SearchDropdown.Visible = false
                TitleSearchBox.Text = ""
                if item.jumpFn then item.jumpFn() end
                SetStatus("Jumped to: " .. item.title)
            end)
        end
    end
    SearchDropdown.Visible = count > 0
end

TitleSearchBox:GetPropertyChangedSignal("Text"):Connect(function()
    if TitleSearchBox.Text ~= "" then
        RebuildSearch(TitleSearchBox.Text)
    else
        SearchDropdown.Visible = false
    end
end)
TitleSearchBox.Focused:Connect(function()
    if TitleSearchBox.Text ~= "" then RebuildSearch(TitleSearchBox.Text) end
end)
TitleSearchBox.FocusLost:Connect(function()
    task.delay(0.15, function() SearchDropdown.Visible = false end)
end)

-- ============================================================
-- NOTIFICATION CONTAINER
-- ============================================================
local NotifContainer                = Instance.new("Frame")
NotifContainer.Name                 = "NotifContainer"
NotifContainer.Size                 = UDim2.new(0, 300, 1, 0)
NotifContainer.Position             = UDim2.new(1, -310, 0, 0)
NotifContainer.BackgroundTransparency = 1
NotifContainer.ZIndex               = 200
NotifContainer.Parent               = ScreenGui
local NotifLayout                   = Instance.new("UIListLayout")
NotifLayout.VerticalAlignment       = Enum.VerticalAlignment.Bottom
NotifLayout.HorizontalAlignment     = Enum.HorizontalAlignment.Right
NotifLayout.Padding                 = UDim.new(0, 8)
NotifLayout.Parent                  = NotifContainer
local NotifPad                      = Instance.new("UIPadding")
NotifPad.PaddingBottom              = UDim.new(0, 16)
NotifPad.PaddingRight               = UDim.new(0, 0)
NotifPad.Parent                     = NotifContainer

-- ============================================================
-- THEME BUTTON + FLOATING COLOR PICKER PANEL
-- ============================================================
-- ThemeTitleBtn is defined in the titlebar section above.
-- The panel opens downward from the top-right of the main frame.

-- ============================================================
-- FLOATING COLOR PICKER PANEL (outside the main UI)
-- ============================================================
local ThemePanel                      = Instance.new("Frame")
ThemePanel.Name                       = "ThemePanel"
ThemePanel.Size                       = UDim2.new(0, 280, 0, 440)
ThemePanel.BackgroundColor3           = T.BG_PANEL
ThemePanel.BorderSizePixel            = 0
ThemePanel.Visible                    = false
ThemePanel.ZIndex                     = 150
ThemePanel.ClipsDescendants           = false
-- Parent to ScreenGui (not MainGroup) so it is never clipped by the CanvasGroup bounds
ThemePanel.Parent                     = ScreenGui
Corner(ThemePanel, UDim.new(0, 12))
Stroke(ThemePanel, Color3.fromRGB(55, 55, 85), 1.5)
OnThemeChange(function(theme) ThemePanel.BackgroundColor3 = theme.BG_PANEL end)

-- Helper: reposition ThemePanel flush to the right of MainGroup
local function SnapThemePanel()
    local p = MainGroup.Position
    local s = MainGroup.Size
    ThemePanel.Position = UDim2.new(
        p.X.Scale, p.X.Offset + s.X.Offset + 10,
        p.Y.Scale, p.Y.Offset)
end

-- Auto-follow MainGroup whenever it moves or resizes
MainGroup:GetPropertyChangedSignal("Position"):Connect(function()
    if ThemePanel.Visible then SnapThemePanel() end
end)
MainGroup:GetPropertyChangedSignal("Size"):Connect(function()
    if ThemePanel.Visible then SnapThemePanel() end
end)

-- Panel header
local TPHeader                        = Instance.new("Frame")
TPHeader.Size                         = UDim2.new(1, 0, 0, 44)
TPHeader.BackgroundColor3             = T.BG_MAIN
TPHeader.BorderSizePixel              = 0
TPHeader.ZIndex                       = 151
TPHeader.Parent                       = ThemePanel
Corner(TPHeader, UDim.new(0, 12))
OnThemeChange(function(theme) TPHeader.BackgroundColor3 = theme.BG_MAIN end)

local TPHeaderMask                    = Instance.new("Frame")
TPHeaderMask.Size                     = UDim2.new(1, 0, 0, 12)
TPHeaderMask.Position                 = UDim2.new(0, 0, 1, -12)
TPHeaderMask.BackgroundColor3         = T.BG_MAIN
TPHeaderMask.BorderSizePixel          = 0
TPHeaderMask.ZIndex                   = 151
TPHeaderMask.Parent                   = TPHeader
OnThemeChange(function(theme) TPHeaderMask.BackgroundColor3 = theme.BG_MAIN end)

local TPDot                           = Instance.new("Frame")
TPDot.Size                            = UDim2.new(0, 8, 0, 8)
TPDot.Position                        = UDim2.new(0, 14, 0.5, -4)
TPDot.BackgroundColor3                = T.ACCENT
TPDot.ZIndex                          = 152
TPDot.Parent                          = TPHeader
Corner(TPDot, UDim.new(1, 0))
OnThemeChange(function(theme) TPDot.BackgroundColor3 = theme.ACCENT end)

local TPTitle                         = Instance.new("TextLabel")
TPTitle.Size                          = UDim2.new(1, -80, 1, 0)
TPTitle.Position                      = UDim2.new(0, 30, 0, 0)
TPTitle.BackgroundTransparency        = 1
TPTitle.Text                          = "Theme Editor"
TPTitle.TextColor3                    = T.TEXT_MAIN
TPTitle.Font                          = Enum.Font.GothamBold
TPTitle.TextSize                      = 13
TPTitle.TextXAlignment                = Enum.TextXAlignment.Left
TPTitle.ZIndex                        = 152
TPTitle.Parent                        = TPHeader
OnThemeChange(function(theme) TPTitle.TextColor3 = theme.TEXT_MAIN end)

-- Preset theme buttons row
local PresetsBar                      = Instance.new("Frame")
PresetsBar.Size                       = UDim2.new(1, -16, 0, 28)
PresetsBar.Position                   = UDim2.new(0, 8, 0, 50)
PresetsBar.BackgroundTransparency     = 1
PresetsBar.ZIndex                     = 151
PresetsBar.Parent                     = ThemePanel
local PresetsLayout                   = Instance.new("UIListLayout")
PresetsLayout.FillDirection           = Enum.FillDirection.Horizontal
PresetsLayout.Padding                 = UDim.new(0, 5)
PresetsLayout.Parent                  = PresetsBar

local presetNames = {"Default", "Midnight", "Rose", "Light"}
for _, pname in ipairs(presetNames) do
    local pb                          = Instance.new("TextButton")
    pb.Size                           = UDim2.new(0, 56, 1, 0)
    pb.BackgroundColor3               = T.BG_ELEMENT
    pb.Text                           = pname
    pb.TextColor3                     = T.TEXT_DIM
    pb.Font                           = Enum.Font.GothamBold
    pb.TextSize                       = 9
    pb.ZIndex                         = 152
    pb.Parent                         = PresetsBar
    Corner(pb, UDim.new(0, 6))
    Stroke(pb, Color3.fromRGB(50, 50, 80), 1)
    OnThemeChange(function(theme)
        pb.BackgroundColor3 = theme.BG_ELEMENT
        pb.TextColor3       = theme.TEXT_DIM
    end)
    pb.MouseEnter:Connect(function() Tween(pb, {BackgroundColor3 = T.BG_HOVER}, 0.12) end)
    pb.MouseLeave:Connect(function() Tween(pb, {BackgroundColor3 = T.BG_ELEMENT}, 0.15) end)
    pb.MouseButton1Click:Connect(function()
        ApplyTheme(pname)
        SetStatus("Theme: " .. pname)
    end)
end

-- Divider
local TPDiv                           = Instance.new("Frame")
TPDiv.Size                            = UDim2.new(1, -16, 0, 1)
TPDiv.Position                        = UDim2.new(0, 8, 0, 84)
TPDiv.BackgroundColor3                = Color3.fromRGB(50, 50, 75)
TPDiv.BorderSizePixel                 = 0
TPDiv.ZIndex                          = 151
TPDiv.Parent                          = ThemePanel

-- Scroll area for color slots
local TPScroll                        = Instance.new("ScrollingFrame")
TPScroll.Size                         = UDim2.new(1, 0, 1, -90)
TPScroll.Position                     = UDim2.new(0, 0, 0, 90)
TPScroll.BackgroundTransparency       = 1
TPScroll.ScrollBarThickness           = 3
TPScroll.ScrollBarImageColor3         = T.ACCENT
TPScroll.CanvasSize                   = UDim2.new(0, 0, 0, 0)
TPScroll.ZIndex                       = 151
TPScroll.Parent                       = ThemePanel
OnThemeChange(function(theme) TPScroll.ScrollBarImageColor3 = theme.ACCENT end)

local TPScrollLayout                  = Instance.new("UIListLayout")
TPScrollLayout.Padding                = UDim.new(0, 0)
TPScrollLayout.Parent                 = TPScroll
TPScrollLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    TPScroll.CanvasSize = UDim2.new(0, 0, 0, TPScrollLayout.AbsoluteContentSize.Y + 8)
end)

local TPScrollPad                     = Instance.new("UIPadding")
TPScrollPad.PaddingLeft               = UDim.new(0, 8)
TPScrollPad.PaddingRight              = UDim.new(0, 8)
TPScrollPad.PaddingTop                = UDim.new(0, 6)
TPScrollPad.PaddingBottom             = UDim.new(0, 6)
TPScrollPad.Parent                    = TPScroll

-- ============================================================
-- HSV COLOR PICKER WIDGET (shared, shown for one slot at a time)
-- ============================================================
local CPWidget                        = Instance.new("Frame")
CPWidget.Name                         = "CPWidget"
CPWidget.Size                         = UDim2.new(1, -16, 0, 220)
CPWidget.BackgroundColor3             = T.BG_MAIN
CPWidget.BorderSizePixel              = 0
CPWidget.Visible                      = false
CPWidget.ZIndex                       = 160
CPWidget.ClipsDescendants             = false
CPWidget.Parent                       = ThemePanel
Corner(CPWidget, UDim.new(0, 8))
Stroke(CPWidget, Color3.fromRGB(50, 50, 80), 1)
OnThemeChange(function(theme) CPWidget.BackgroundColor3 = theme.BG_MAIN end)

-- SV square (saturation x, value y)
local SVSquare                        = Instance.new("Frame")
SVSquare.Name                         = "SVSquare"
SVSquare.Size                         = UDim2.new(1, -48, 1, -58)
SVSquare.Position                     = UDim2.new(0, 8, 0, 8)
SVSquare.BackgroundColor3             = Color3.fromHSV(0, 1, 1)
SVSquare.ZIndex                       = 161
SVSquare.BorderSizePixel              = 0
SVSquare.Parent                       = CPWidget
Corner(SVSquare, UDim.new(0, 6))

-- White gradient overlay (saturation) - white on left, transparent on right
local SVGradW                         = Instance.new("UIGradient")
SVGradW.Color                         = ColorSequence.new(Color3.new(1,1,1), Color3.new(1,1,1))
SVGradW.Transparency                  = NumberSequence.new({
    NumberSequenceKeypoint.new(0, 0),
    NumberSequenceKeypoint.new(1, 1),
})
SVGradW.Parent                        = SVSquare

-- Black gradient overlay (value) - transparent at top, black at bottom
local SVGradBlack                     = Instance.new("Frame")
SVGradBlack.Size                      = UDim2.new(1, 0, 1, 0)
SVGradBlack.BackgroundColor3          = Color3.new(0,0,0)
SVGradBlack.BackgroundTransparency    = 1
SVGradBlack.ZIndex                    = 162
SVGradBlack.BorderSizePixel           = 0
SVGradBlack.Parent                    = SVSquare
Corner(SVGradBlack, UDim.new(0, 6))
local SVGradB                         = Instance.new("UIGradient")
SVGradB.Color                         = ColorSequence.new(Color3.new(0,0,0), Color3.new(0,0,0))
SVGradB.Transparency                  = NumberSequence.new({
    NumberSequenceKeypoint.new(0, 1),
    NumberSequenceKeypoint.new(1, 0),
})
SVGradB.Rotation                      = 90
SVGradB.Parent                        = SVGradBlack

-- SV cursor
local SVCursor                        = Instance.new("Frame")
SVCursor.Size                         = UDim2.new(0, 12, 0, 12)
SVCursor.AnchorPoint                  = Vector2.new(0.5, 0.5)
SVCursor.BackgroundColor3             = Color3.new(1,1,1)
SVCursor.BorderSizePixel              = 0
SVCursor.ZIndex                       = 164
SVCursor.Parent                       = SVSquare
Corner(SVCursor, UDim.new(1, 0))
Stroke(SVCursor, Color3.new(0,0,0), 1.5)

-- SV interaction button
local SVBtn                           = Instance.new("TextButton")
SVBtn.Size                            = UDim2.new(1, 0, 1, 0)
SVBtn.BackgroundTransparency          = 1
SVBtn.Text                            = ""
SVBtn.ZIndex                          = 165
SVBtn.Parent                          = SVSquare

-- Hue strip (vertical, right side)
local HueStrip                        = Instance.new("Frame")
HueStrip.Size                         = UDim2.new(0, 20, 1, -58)
HueStrip.Position                     = UDim2.new(1, -34, 0, 8)
HueStrip.BackgroundColor3             = Color3.new(1,1,1)
HueStrip.ZIndex                       = 161
HueStrip.BorderSizePixel              = 0
HueStrip.Parent                       = CPWidget
Corner(HueStrip, UDim.new(0, 5))
local HueGrad                         = Instance.new("UIGradient")
HueGrad.Color                         = ColorSequence.new({
    ColorSequenceKeypoint.new(0,    Color3.fromHSV(0,   1, 1)),
    ColorSequenceKeypoint.new(0.17, Color3.fromHSV(0.17,1, 1)),
    ColorSequenceKeypoint.new(0.33, Color3.fromHSV(0.33,1, 1)),
    ColorSequenceKeypoint.new(0.50, Color3.fromHSV(0.50,1, 1)),
    ColorSequenceKeypoint.new(0.67, Color3.fromHSV(0.67,1, 1)),
    ColorSequenceKeypoint.new(0.83, Color3.fromHSV(0.83,1, 1)),
    ColorSequenceKeypoint.new(1,    Color3.fromHSV(1,   1, 1)),
})
HueGrad.Rotation                      = 90
HueGrad.Parent                        = HueStrip

-- Hue thumb
local HueThumb                        = Instance.new("Frame")
HueThumb.Size                         = UDim2.new(1, 4, 0, 6)
HueThumb.AnchorPoint                  = Vector2.new(0.5, 0.5)
HueThumb.Position                     = UDim2.new(0.5, 0, 0, 0)
HueThumb.BackgroundColor3             = Color3.new(1,1,1)
HueThumb.ZIndex                       = 163
HueThumb.BorderSizePixel              = 0
HueThumb.Parent                       = HueStrip
Corner(HueThumb, UDim.new(0, 3))
Stroke(HueThumb, Color3.new(0,0,0), 1)

-- Hue interaction button
local HueBtn                          = Instance.new("TextButton")
HueBtn.Size                           = UDim2.new(1, 0, 1, 0)
HueBtn.BackgroundTransparency         = 1
HueBtn.Text                           = ""
HueBtn.ZIndex                         = 165
HueBtn.Parent                         = HueStrip

-- Hex input + preview row
local CPBottom                        = Instance.new("Frame")
CPBottom.Size                         = UDim2.new(1, -16, 0, 32)
CPBottom.Position                     = UDim2.new(0, 8, 1, -40)
CPBottom.BackgroundTransparency       = 1
CPBottom.ZIndex                       = 161
CPBottom.Parent                       = CPWidget

local CPPreview                       = Instance.new("Frame")
CPPreview.Size                        = UDim2.new(0, 32, 0, 28)
CPPreview.BackgroundColor3            = Color3.new(1,1,1)
CPPreview.ZIndex                      = 162
CPPreview.BorderSizePixel             = 0
CPPreview.Parent                      = CPBottom
Corner(CPPreview, UDim.new(0, 5))
Stroke(CPPreview, Color3.fromRGB(60,60,100), 1)

local CPHexBox                        = Instance.new("TextBox")
CPHexBox.Size                         = UDim2.new(1, -44, 1, 0)
CPHexBox.Position                     = UDim2.new(0, 40, 0, 0)
CPHexBox.BackgroundColor3             = T.BG_ELEMENT
CPHexBox.Text                         = "ffffff"
CPHexBox.TextColor3                   = T.ACCENT
CPHexBox.Font                         = Enum.Font.GothamBold
CPHexBox.TextSize                     = 12
CPHexBox.ClearTextOnFocus             = true
CPHexBox.ZIndex                       = 162
CPHexBox.Parent                       = CPBottom
Corner(CPHexBox, UDim.new(0, 5))
Stroke(CPHexBox, Color3.fromRGB(55, 55, 90), 1)
OnThemeChange(function(theme)
    CPHexBox.BackgroundColor3 = theme.BG_ELEMENT
    CPHexBox.TextColor3       = theme.ACCENT
end)
local CPHexPad                        = Instance.new("UIPadding")
CPHexPad.PaddingLeft                  = UDim.new(0, 6)
CPHexPad.Parent                       = CPHexBox

-- Internal state for the picker
local cpHue, cpSat, cpVal = 0, 1, 1
local cpActiveSlot        = nil  -- which color slot key is being edited
local cpCallback          = nil  -- function(Color3) called when color changes

local function HexToColor3(hex)
    hex = hex:gsub("#", "")
    if #hex ~= 6 then return nil end
    local r = tonumber(hex:sub(1,2), 16)
    local g = tonumber(hex:sub(3,4), 16)
    local b = tonumber(hex:sub(5,6), 16)
    if not (r and g and b) then return nil end
    return Color3.fromRGB(r, g, b)
end

local function Color3ToHex(c)
    return string.format("%02x%02x%02x",
        math.floor(c.R * 255 + 0.5),
        math.floor(c.G * 255 + 0.5),
        math.floor(c.B * 255 + 0.5))
end

local function UpdateCPVisuals()
    local col = Color3.fromHSV(cpHue, cpSat, cpVal)
    SVSquare.BackgroundColor3 = Color3.fromHSV(cpHue, 1, 1)
    CPPreview.BackgroundColor3 = col
    CPHexBox.Text = Color3ToHex(col)
    SVCursor.Position = UDim2.new(cpSat, -6, 1 - cpVal, -6)
    HueThumb.Position = UDim2.new(0.5, 0, cpHue, 0)
    if cpCallback then cpCallback(col) end
end

local function OpenCPWidget(slotKey, currentColor, onChangeFn, anchorY)
    cpHue, cpSat, cpVal = Color3.toHSV(currentColor)
    cpActiveSlot = slotKey
    cpCallback   = onChangeFn
    CPWidget.Position = UDim2.new(0, 8, 0, anchorY)
    CPWidget.Visible  = true
    UpdateCPVisuals()
end

local svDragging  = false
local hueDragging = false

SVBtn.InputBegan:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton1 then
        svDragging = true
        local mp  = Vector2.new(i.Position.X, i.Position.Y)
        local rel = mp - SVSquare.AbsolutePosition
        cpSat = math.clamp(rel.X / SVSquare.AbsoluteSize.X, 0, 1)
        cpVal = 1 - math.clamp(rel.Y / SVSquare.AbsoluteSize.Y, 0, 1)
        UpdateCPVisuals()
    end
end)
HueBtn.InputBegan:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton1 then
        hueDragging = true
        local mp  = Vector2.new(i.Position.X, i.Position.Y)
        local rel = mp - HueStrip.AbsolutePosition
        cpHue = math.clamp(rel.Y / HueStrip.AbsoluteSize.Y, 0, 1)
        UpdateCPVisuals()
    end
end)
UserInputService.InputChanged:Connect(function(i)
    if i.UserInputType ~= Enum.UserInputType.MouseMovement then return end
    local mp = Vector2.new(i.Position.X, i.Position.Y)
    if svDragging then
        local rel = mp - SVSquare.AbsolutePosition
        cpSat = math.clamp(rel.X / SVSquare.AbsoluteSize.X, 0, 1)
        cpVal = 1 - math.clamp(rel.Y / SVSquare.AbsoluteSize.Y, 0, 1)
        UpdateCPVisuals()
    end
    if hueDragging then
        local rel = mp - HueStrip.AbsolutePosition
        cpHue = math.clamp(rel.Y / HueStrip.AbsoluteSize.Y, 0, 1)
        UpdateCPVisuals()
    end
end)
UserInputService.InputEnded:Connect(function(i)
    if i.UserInputType == Enum.UserInputType.MouseButton1 then
        svDragging  = false
        hueDragging = false
    end
end)
CPHexBox.FocusLost:Connect(function()
    local c = HexToColor3(CPHexBox.Text)
    if c then
        cpHue, cpSat, cpVal = Color3.toHSV(c)
        UpdateCPVisuals()
    else
        -- Restore valid hex
        CPHexBox.Text = Color3ToHex(Color3.fromHSV(cpHue, cpSat, cpVal))
    end
end)

-- ============================================================
-- COLOR SLOT ROWS in ThemePanel scroll
-- ============================================================
local colorSlots = {
    { key = "ACCENT",      label = "Accent" },
    { key = "ACCENT_DARK", label = "Accent Dark" },
    { key = "BG_MAIN",     label = "Background" },
    { key = "BG_PANEL",    label = "Panel" },
    { key = "BG_SIDEBAR",  label = "Sidebar" },
    { key = "BG_ELEMENT",  label = "Element" },
    { key = "BG_HOVER",    label = "Hover" },
    { key = "TEXT_MAIN",   label = "Text" },
    { key = "TEXT_DIM",    label = "Text Dim" },
    { key = "GREEN",       label = "Success" },
    { key = "RED",         label = "Danger" },
}

local slotSwatches = {}  -- key -> Frame swatch

-- Custom theme table that starts as a copy of current T
local function GetCustomTheme()
    local ct = {}
    for k, v in pairs(T) do ct[k] = v end
    return ct
end
local customTheme = GetCustomTheme()

for i, slot in ipairs(colorSlots) do
    local row                         = Instance.new("Frame")
    row.Size                          = UDim2.new(1, 0, 0, 32)
    row.BackgroundTransparency        = 1
    row.ZIndex                        = 152
    row.Parent                        = TPScroll

    local lbl                         = Instance.new("TextLabel")
    lbl.Size                          = UDim2.new(1, -52, 1, 0)
    lbl.BackgroundTransparency        = 1
    lbl.Text                          = slot.label
    lbl.TextColor3                    = T.TEXT_MAIN
    lbl.Font                          = Enum.Font.Gotham
    lbl.TextSize                      = 11
    lbl.TextXAlignment                = Enum.TextXAlignment.Left
    lbl.ZIndex                        = 153
    lbl.Parent                        = row
    OnThemeChange(function(theme) lbl.TextColor3 = theme.TEXT_MAIN end)

    local swatch                      = Instance.new("TextButton")
    swatch.Size                       = UDim2.new(0, 40, 0, 22)
    swatch.Position                   = UDim2.new(1, -44, 0.5, -11)
    swatch.BackgroundColor3           = T[slot.key]
    swatch.Text                       = ""
    swatch.ZIndex                     = 153
    swatch.Parent                     = row
    Corner(swatch, UDim.new(0, 5))
    Stroke(swatch, Color3.fromRGB(60, 60, 100), 1)
    slotSwatches[slot.key] = swatch

    -- Divider line (not after last)
    if i < #colorSlots then
        local div                     = Instance.new("Frame")
        div.Size                      = UDim2.new(1, 0, 0, 1)
        div.BackgroundColor3          = Color3.fromRGB(40, 40, 65)
        div.BorderSizePixel           = 0
        div.ZIndex                    = 152
        div.Parent                    = row
        div.Position                  = UDim2.new(0, 0, 1, -1)
    end

    -- Open picker when swatch clicked
    local slotKey = slot.key
    swatch.MouseButton1Click:Connect(function()
        -- Close if same slot already open
        if CPWidget.Visible and cpActiveSlot == slotKey then
            CPWidget.Visible = false
            return
        end
        -- Anchor below the row inside the scroll
        local rowAbsY    = row.AbsolutePosition.Y
        local panelAbsY  = ThemePanel.AbsolutePosition.Y
        local anchorY    = rowAbsY - panelAbsY + 36
        -- Clamp so picker doesn't go off bottom
        anchorY = math.clamp(anchorY, 90, ThemePanel.AbsoluteSize.Y - 235)

        OpenCPWidget(slotKey, customTheme[slotKey] or T[slotKey], function(newColor)
            customTheme[slotKey] = newColor
            swatch.BackgroundColor3 = newColor
            -- Apply live to current theme
            T[slotKey] = newColor
            for _, fn in ipairs(themeListeners) do
                pcall(fn, T)
            end
            -- Persist the updated theme
            SaveTheme(T)
        end, anchorY)
    end)

    -- Keep swatch color in sync with theme changes
    OnThemeChange(function(theme)
        if cpActiveSlot ~= slotKey then
            swatch.BackgroundColor3 = theme[slotKey] or swatch.BackgroundColor3
            customTheme[slotKey]    = theme[slotKey] or customTheme[slotKey]
        end
    end)
end

local themePanelOpen = false
ThemeTitleBtn.MouseButton1Click:Connect(function()
    themePanelOpen = not themePanelOpen
    if themePanelOpen then
        SnapThemePanel()
        -- Slide in from slightly left
        local p = ThemePanel.Position
        ThemePanel.Position = UDim2.new(p.X.Scale, p.X.Offset - 6, p.Y.Scale, p.Y.Offset)
        ThemePanel.Visible  = true
        SnapThemePanel()
        Tween(ThemePanel, {Position = UDim2.new(
            MainGroup.Position.X.Scale,
            MainGroup.Position.X.Offset + MainGroup.Size.X.Offset + 10,
            MainGroup.Position.Y.Scale,
            MainGroup.Position.Y.Offset)}, 0.2)
        Tween(ThemeTitleBtn, {BackgroundColor3 = T.ACCENT}, 0.15)
    else
        local p = ThemePanel.Position
        Tween(ThemePanel, {Position = UDim2.new(p.X.Scale, p.X.Offset - 6, p.Y.Scale, p.Y.Offset)}, 0.15)
        task.delay(0.17, function() ThemePanel.Visible = false end)
        Tween(ThemeTitleBtn, {BackgroundColor3 = T.BG_ELEMENT}, 0.15)
        CPWidget.Visible = false
    end
end)

-- ============================================================
-- LIBRARY API
-- ============================================================
local Library = {}

-- Set the colour theme programmatically
-- Usage: Library:SetTheme("Midnight") -- or "Default", "Rose", "Light"
-- Or pass a custom table: Library:SetTheme({ACCENT=..., BG_MAIN=..., ...})
function Library:SetTheme(nameOrTable)
    if type(nameOrTable) == "string" then
        ApplyTheme(nameOrTable)  -- ApplyTheme already saves
        SetStatus("Theme: " .. nameOrTable)
    elseif type(nameOrTable) == "table" then
        -- Merge with Default to fill any missing keys
        local merged = {}
        for k, v in pairs(THEMES.Default) do merged[k] = v end
        for k, v in pairs(nameOrTable) do merged[k] = v end
        THEMES["_Custom"] = merged
        ApplyTheme("_Custom")   -- ApplyTheme already saves
        SetStatus("Custom theme applied")
    end
end

-- Set window size programmatically
-- Usage: Library:SetSize(1.25) -- scale multiplier
-- Or: Library:SetSize("Large") -- "Small"=0.8, "Default"=1.0, "Large"=1.25, "XL"=1.5
function Library:SetSize(scaleOrName)
    local presets = {Small=0.8, Default=1.0, Large=1.25, XL=1.5}
    local scale = type(scaleOrName) == "string" and (presets[scaleOrName] or 1.0) or (tonumber(scaleOrName) or 1.0)
    local newW = DEFAULT_W * scale
    local newH = DEFAULT_H * scale
    Tween(MainGroup, {Size = UDim2.new(0, newW, 0, newH)}, 0.25)
    ApplyScale(scale)
    SetStatus("Size: " .. tostring(scaleOrName))
end

-- Show a notification toast
-- Usage:
--   Library:Notify({ Title="Hello", Content="World!", Duration=3, Icon="ðŸ””" })
function Library:Notify(cfg)
    cfg = cfg or {}
    local title    = cfg.Title    or "Notification"
    local content  = cfg.Content  or ""
    local duration = cfg.Duration or 4
    local icon     = cfg.Icon     or ""

    local notif                     = Instance.new("Frame")
    notif.Size                      = UDim2.new(1, 0, 0, 0)
    notif.AutomaticSize             = Enum.AutomaticSize.Y
    notif.BackgroundColor3          = T.BG_PANEL
    notif.BorderSizePixel           = 0
    notif.ZIndex                    = 201
    notif.ClipsDescendants          = false
    notif.Parent                    = NotifContainer
    Corner(notif, UDim.new(0, 10))
    Stroke(notif, Color3.fromRGB(55, 55, 85), 1)
    OnThemeChange(function(theme) notif.BackgroundColor3 = theme.BG_PANEL end)

    -- Accent bar on left
    local Bar                       = Instance.new("Frame")
    Bar.Size                        = UDim2.new(0, 3, 1, -16)
    Bar.Position                    = UDim2.new(0, 8, 0, 8)
    Bar.BackgroundColor3            = T.ACCENT
    Bar.BorderSizePixel             = 0
    Bar.ZIndex                      = 202
    Bar.Parent                      = notif
    Corner(Bar, UDim.new(1, 0))
    OnThemeChange(function(theme) Bar.BackgroundColor3 = theme.ACCENT end)

    local padding                   = Instance.new("UIPadding")
    padding.PaddingLeft             = UDim.new(0, 18)
    padding.PaddingRight            = UDim.new(0, 12)
    padding.PaddingTop              = UDim.new(0, 10)
    padding.PaddingBottom           = UDim.new(0, 10)
    padding.Parent                  = notif

    local inner                     = Instance.new("Frame")
    inner.Size                      = UDim2.new(1, 0, 0, 0)
    inner.AutomaticSize             = Enum.AutomaticSize.Y
    inner.BackgroundTransparency    = 1
    inner.ZIndex                    = 202
    inner.Parent                    = notif
    local innerLayout               = Instance.new("UIListLayout")
    innerLayout.Padding             = UDim.new(0, 3)
    innerLayout.Parent              = inner

    local TitleRow                  = Instance.new("Frame")
    TitleRow.Size                   = UDim2.new(1, 0, 0, 0)
    TitleRow.AutomaticSize          = Enum.AutomaticSize.Y
    TitleRow.BackgroundTransparency = 1
    TitleRow.ZIndex                 = 202
    TitleRow.Parent                 = inner
    local TitleRowLayout            = Instance.new("UIListLayout")
    TitleRowLayout.FillDirection    = Enum.FillDirection.Horizontal
    TitleRowLayout.VerticalAlignment= Enum.VerticalAlignment.Center
    TitleRowLayout.Padding          = UDim.new(0, 5)
    TitleRowLayout.Parent           = TitleRow

    if icon ~= "" then
        local iconLbl               = Instance.new("TextLabel")
        iconLbl.Size                = UDim2.new(0, 18, 0, 18)
        iconLbl.BackgroundTransparency = 1
        iconLbl.Text                = icon
        iconLbl.Font                = Enum.Font.Gotham
        iconLbl.TextSize            = 14
        iconLbl.TextColor3          = T.ACCENT
        iconLbl.ZIndex              = 203
        iconLbl.Parent              = TitleRow
        OnThemeChange(function(theme) iconLbl.TextColor3 = theme.ACCENT end)
    end

    local titleLbl                  = Instance.new("TextLabel")
    titleLbl.Size                   = UDim2.new(1, 0, 0, 18)
    titleLbl.BackgroundTransparency = 1
    titleLbl.Text                   = title
    titleLbl.TextColor3             = T.TEXT_MAIN
    titleLbl.Font                   = Enum.Font.GothamBold
    titleLbl.TextSize               = 13
    titleLbl.TextXAlignment         = Enum.TextXAlignment.Left
    titleLbl.ZIndex                 = 203
    titleLbl.Parent                 = TitleRow
    OnThemeChange(function(theme) titleLbl.TextColor3 = theme.TEXT_MAIN end)

    if content ~= "" then
        local contentLbl            = Instance.new("TextLabel")
        contentLbl.Size             = UDim2.new(1, 0, 0, 0)
        contentLbl.AutomaticSize    = Enum.AutomaticSize.Y
        contentLbl.BackgroundTransparency = 1
        contentLbl.Text             = content
        contentLbl.TextColor3       = T.TEXT_DIM
        contentLbl.Font             = Enum.Font.Gotham
        contentLbl.TextSize         = 11
        contentLbl.TextXAlignment   = Enum.TextXAlignment.Left
        contentLbl.TextWrapped      = true
        contentLbl.ZIndex           = 203
        contentLbl.Parent           = inner
        OnThemeChange(function(theme) contentLbl.TextColor3 = theme.TEXT_DIM end)
    end

    -- Progress bar at bottom
    local ProgTrack                 = Instance.new("Frame")
    ProgTrack.Size                  = UDim2.new(1, -2, 0, 2)
    ProgTrack.Position              = UDim2.new(0, 1, 1, -3)
    ProgTrack.BackgroundColor3      = Color3.fromRGB(40, 40, 65)
    ProgTrack.BorderSizePixel       = 0
    ProgTrack.ZIndex                = 202
    ProgTrack.Parent                = notif
    Corner(ProgTrack, UDim.new(1, 0))

    local ProgFill                  = Instance.new("Frame")
    ProgFill.Size                   = UDim2.new(1, 0, 1, 0)
    ProgFill.BackgroundColor3       = T.ACCENT
    ProgFill.BorderSizePixel        = 0
    ProgFill.ZIndex                 = 203
    ProgFill.Parent                 = ProgTrack
    Corner(ProgFill, UDim.new(1, 0))
    OnThemeChange(function(theme) ProgFill.BackgroundColor3 = theme.ACCENT end)

    -- Slide in
    notif.Position = UDim2.new(0, 20, 0, 0)
    Tween(notif, {Position = UDim2.new(0, 0, 0, 0)}, 0.25)

    -- Progress tween
    Tween(ProgFill, {Size = UDim2.new(0, 0, 1, 0)}, duration, Enum.EasingStyle.Linear)

    -- Click to dismiss
    local closeConn
    local dismissed = false
    local function Dismiss()
        if dismissed then return end
        dismissed = true
        Tween(notif, {Position = UDim2.new(0, 320, 0, 0)}, 0.2)
        task.delay(0.22, function() notif:Destroy() end)
    end
    notif.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 then Dismiss() end
    end)
    task.delay(duration + 0.1, Dismiss)
end

function Library:CreateWindow(cfg)
    cfg = cfg or {}
    if cfg.Title   then TitleLabel.Text   = cfg.Title   end
    if cfg.Version then
        local vl               = Instance.new("TextLabel")
        vl.Size                = UDim2.new(0, 44, 0, 16)
        vl.Position            = UDim2.new(0, 160, 0.5, -8)
        vl.BackgroundColor3    = Color3.fromRGB(30, 30, 50)
        vl.Text                = cfg.Version
        vl.TextColor3          = T.TEXT_DIM
        vl.Font                = Enum.Font.Gotham
        vl.TextSize            = 10
        vl.ZIndex              = 5
        vl.Parent              = TitleBar
        Corner(vl, UDim.new(0, 4))
        OnThemeChange(function(theme) vl.TextColor3 = theme.TEXT_DIM end)
    end

    local Window = {}
    Window._toggleKey = nil

    function Window:SetToggleKey(keyCode)
        self._toggleKey = keyCode
    end

    UserInputService.InputBegan:Connect(function(io, gpe)
        if gpe then return end
        if Window._toggleKey and io.KeyCode == Window._toggleKey then
            if MainGroup.Visible then
                FadeOut(MainGroup, 0.15, function()
                    MainGroup.Visible  = false
                    OpenButton.Visible = true
                end)
            else
                OpenButton.Visible = false
                FadeIn(MainGroup, 0.2)
            end
        end
    end)

    function Window:Destroy()
        FadeOut(MainGroup, 0.18, function() ScreenGui:Destroy() end)
    end

    function Window:SetTitle(str)
        TitleLabel.Text = str
    end

    function Window:Tab(cfg2)
        local name = cfg2.Title or "Tab"
        local icon = cfg2.Icon

        local Page                      = Instance.new("ScrollingFrame")
        Page.Size                       = UDim2.new(1, 0, 1, 0)
        Page.BackgroundTransparency     = 1
        Page.Visible                    = false
        Page.ScrollBarThickness         = 3
        Page.ScrollBarImageColor3       = T.ACCENT
        Page.ZIndex                     = 3
        Page.Parent                     = ContentArea
        OnThemeChange(function(theme) Page.ScrollBarImageColor3 = theme.ACCENT end)

        local PageLayout                = Instance.new("UIListLayout")
        PageLayout.Parent               = Page
        PageLayout.Padding              = UDim.new(0, 6)
        PageLayout.SortOrder            = Enum.SortOrder.LayoutOrder

        local PagePad                   = Instance.new("UIPadding")
        PagePad.PaddingLeft             = UDim.new(0, 10)
        PagePad.PaddingRight            = UDim.new(0, 10)
        PagePad.PaddingTop              = UDim.new(0, 10)
        PagePad.PaddingBottom           = UDim.new(0, 10)
        PagePad.Parent                  = Page

        PageLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            Page.CanvasSize = UDim2.new(0, 0, 0, PageLayout.AbsoluteContentSize.Y + 20)
        end)

        local TabBtn                    = Instance.new("TextButton")
        TabBtn.Size                     = UDim2.new(0, 135, 0, 36)
        TabBtn.BackgroundColor3         = T.BG_ELEMENT
        TabBtn.Text                     = (icon and icon .. "  " or "") .. name
        TabBtn.TextColor3               = T.TEXT_DIM
        TabBtn.Font                     = Enum.Font.Gotham
        TabBtn.TextSize                 = 12
        TabBtn.ZIndex                   = 5
        TabBtn.Parent                   = TabContainer
        Corner(TabBtn, UDim.new(0, 7))
        OnThemeChange(function(theme)
            TabBtn.BackgroundColor3 = theme.BG_ELEMENT
            TabBtn.TextColor3       = theme.TEXT_DIM
        end)

        local Indicator                 = Instance.new("Frame")
        Indicator.Size                  = UDim2.new(0, 3, 0, 18)
        Indicator.Position              = UDim2.new(0, 4, 0.5, -9)
        Indicator.BackgroundColor3      = T.ACCENT
        Indicator.BorderSizePixel       = 0
        Indicator.BackgroundTransparency= 1
        Indicator.ZIndex                = 6
        Indicator.Parent                = TabBtn
        Corner(Indicator, UDim.new(1, 0))
        OnThemeChange(function(theme) Indicator.BackgroundColor3 = theme.ACCENT end)

        local function Activate()
            for _, v in pairs(ContentArea:GetChildren()) do
                if v:IsA("ScrollingFrame") then v.Visible = false end
            end
            for _, btn in pairs(TabContainer:GetChildren()) do
                if btn:IsA("TextButton") then
                    Tween(btn, {BackgroundColor3 = T.BG_ELEMENT, TextColor3 = T.TEXT_DIM}, 0.15)
                    local ind = btn:FindFirstChildWhichIsA("Frame")
                    if ind then Tween(ind, {BackgroundTransparency = 1}, 0.15) end
                end
            end
            Page.Visible = true
            Tween(TabBtn, {BackgroundColor3 = Color3.fromRGB(30, 30, 50), TextColor3 = T.TEXT_MAIN}, 0.15)
            Tween(Indicator, {BackgroundTransparency = 0}, 0.15)
            SetStatus(name)
        end

        TabBtn.MouseButton1Click:Connect(Activate)
        if #ContentArea:GetChildren() == 1 then task.defer(Activate) end

        local Tab   = {}
        local order = 0
        local function NextOrder() order += 1; return order end

        local function ScaledSize(baseH)
            return math.floor(baseH * currentFontScale)
        end
        local function ScaledText(baseSize)
            return math.floor(baseSize * currentFontScale)
        end

        function Tab:Select() Activate() end

        function Tab:Section(cfg3)
            local text     = cfg3.Title or ""
            local hasTitle = text ~= ""
            local container= Instance.new("Frame")
            container.Size = UDim2.new(1, 0, 0, 30)
            container.BackgroundTransparency = 1
            container.LayoutOrder = NextOrder()
            container.Parent      = Page

            if hasTitle then
                local function Line(xScale, xOffset)
                    local f = Instance.new("Frame")
                    f.BackgroundColor3 = Color3.fromRGB(48, 48, 72)
                    f.Size             = UDim2.new(0.5, -56, 0, 1)
                    f.Position         = UDim2.new(xScale, xOffset, 0.5, 0)
                    f.BorderSizePixel  = 0
                    f.Parent           = container
                end
                Line(0, 0); Line(0.5, 56)

                local pill                  = Instance.new("Frame")
                pill.BackgroundColor3       = T.BG_ELEMENT
                pill.BorderSizePixel        = 0
                pill.Position               = UDim2.new(0.5, 0, 0.5, 0)
                pill.AnchorPoint            = Vector2.new(0.5, 0.5)
                pill.AutomaticSize          = Enum.AutomaticSize.X
                pill.Size                   = UDim2.new(0, 0, 0, 20)
                pill.ZIndex                 = 2
                pill.Parent                 = container
                Corner(pill, UDim.new(1, 0))
                Stroke(pill, Color3.fromRGB(58, 58, 88), 1)
                OnThemeChange(function(theme) pill.BackgroundColor3 = theme.BG_ELEMENT end)

                local pillPad               = Instance.new("UIPadding")
                pillPad.PaddingLeft         = UDim.new(0, 10)
                pillPad.PaddingRight        = UDim.new(0, 10)
                pillPad.Parent              = pill

                local lbl                   = Instance.new("TextLabel")
                lbl.Size                    = UDim2.new(0, 0, 1, 0)
                lbl.AutomaticSize           = Enum.AutomaticSize.X
                lbl.BackgroundTransparency  = 1
                lbl.Text                    = text:upper()
                lbl.TextColor3              = T.TEXT_DIM
                lbl.Font                    = Enum.Font.GothamBold
                lbl.TextSize                = 9
                lbl.ZIndex                  = 3
                lbl.Parent                  = pill
                OnThemeChange(function(theme) lbl.TextColor3 = theme.TEXT_DIM end)
            else
                local f = Instance.new("Frame")
                f.BackgroundColor3 = Color3.fromRGB(48, 48, 72)
                f.Size             = UDim2.new(1, 0, 0, 1)
                f.Position         = UDim2.new(0, 0, 0.5, 0)
                f.BorderSizePixel  = 0
                f.Parent           = container
            end
        end

        local function MakeRow(height, layoutOrder)
            local row               = Instance.new("Frame")
            row.Size                = UDim2.new(1, 0, 0, height)
            row.BackgroundColor3    = T.BG_ELEMENT
            row.LayoutOrder         = layoutOrder
            row.Parent              = Page
            Corner(row, UDim.new(0, 7))
            Stroke(row, Color3.fromRGB(38, 38, 60))
            OnThemeChange(function(theme) row.BackgroundColor3 = theme.BG_ELEMENT end)
            return row
        end

        local function MakeTitleLabel(parent, text, hasDesc, rightOffset)
            local lbl               = Instance.new("TextLabel")
            lbl.Size                = UDim2.new(1, -(rightOffset or 20), 0, 20)
            lbl.Position            = hasDesc and UDim2.new(0, 12, 0, 6) or UDim2.new(0, 12, 0.5, -10)
            lbl.BackgroundTransparency = 1
            lbl.Text                = text
            lbl.TextColor3          = T.TEXT_MAIN
            lbl.Font                = Enum.Font.Gotham
            lbl.TextSize            = 13
            lbl.TextXAlignment      = Enum.TextXAlignment.Left
            lbl.Parent              = parent
            OnThemeChange(function(theme) lbl.TextColor3 = theme.TEXT_MAIN end)
            OnFontScaleChange(function(s) lbl.TextSize = math.floor(13 * s) end)
            return lbl
        end

        local function MakeDescLabel(parent, text, yOffset)
            local d                 = Instance.new("TextLabel")
            d.Size                  = UDim2.new(1, -20, 0, 14)
            d.Position              = UDim2.new(0, 12, 0, yOffset or 26)
            d.BackgroundTransparency= 1
            d.Text                  = text
            d.TextColor3            = T.TEXT_DIM
            d.Font                  = Enum.Font.Gotham
            d.TextSize              = 10
            d.TextXAlignment        = Enum.TextXAlignment.Left
            d.Parent                = parent
            OnThemeChange(function(theme) d.TextColor3 = theme.TEXT_DIM end)
            OnFontScaleChange(function(s) d.TextSize = math.floor(10 * s) end)
            return d
        end

        function Tab:Toggle(cfg3)
            local text     = cfg3.Title    or "Toggle"
            local default  = cfg3.Value    or false
            local callback = cfg3.Callback
            local active   = default
            local hasDesc  = cfg3.Desc     ~= nil

            local Row = MakeRow(hasDesc and 46 or 38, NextOrder())
            HoverEffect(Row, function() return T.BG_ELEMENT end, function() return T.BG_HOVER end)
            MakeTitleLabel(Row, text, hasDesc, 60)
            if hasDesc then MakeDescLabel(Row, cfg3.Desc) end

            local Track             = Instance.new("Frame")
            Track.Size              = UDim2.new(0, 38, 0, 20)
            Track.Position          = UDim2.new(1, -48, 0.5, -10)
            Track.BackgroundColor3  = active and T.ACCENT or Color3.fromRGB(50, 50, 70)
            Track.Parent            = Row
            Corner(Track, UDim.new(1, 0))

            local Knob              = Instance.new("Frame")
            Knob.Size               = UDim2.new(0, 14, 0, 14)
            Knob.Position           = active and UDim2.new(1, -17, 0.5, -7) or UDim2.new(0, 3, 0.5, -7)
            Knob.BackgroundColor3   = Color3.new(1, 1, 1)
            Knob.ZIndex             = 2
            Knob.Parent             = Track
            Corner(Knob, UDim.new(1, 0))

            local function Refresh()
                Tween(Track, {BackgroundColor3 = active and T.ACCENT or Color3.fromRGB(50, 50, 70)}, 0.15)
                Tween(Knob,  {Position = active and UDim2.new(1, -17, 0.5, -7) or UDim2.new(0, 3, 0.5, -7)}, 0.15)
            end
            OnThemeChange(function() Refresh() end)

            local Btn               = Instance.new("TextButton")
            Btn.Size                = UDim2.new(1, 0, 1, 0)
            Btn.BackgroundTransparency = 1
            Btn.Text                = ""
            Btn.Parent              = Row
            Btn.MouseButton1Click:Connect(function()
                active = not active; Refresh()
                if callback then callback(active) end
                SetStatus(text .. ": " .. (active and "ON" or "OFF"), active and T.GREEN or T.RED)
            end)

            table.insert(allSearchItems, {
                title  = text,
                kind   = "Toggle",
                jumpFn = function() Activate(); Page.CanvasPosition = Vector2.new(0, Row.AbsolutePosition.Y - Page.AbsolutePosition.Y) end
            })

            local ctrl = {}
            function ctrl:Set(v) active = v; Refresh(); if callback then callback(active) end end
            function ctrl:Get() return active end
            return ctrl
        end

        function Tab:Button(cfg3)
            local text     = cfg3.Title    or "Button"
            local callback = cfg3.Callback
            local hasDesc  = cfg3.Desc     ~= nil

            local Btn               = Instance.new("TextButton")
            Btn.Size                = UDim2.new(1, 0, 0, hasDesc and 46 or 36)
            Btn.BackgroundColor3    = T.BG_ELEMENT
            Btn.Text                = ""
            Btn.LayoutOrder         = NextOrder()
            Btn.Parent              = Page
            Corner(Btn, UDim.new(0, 7))
            Stroke(Btn, Color3.fromRGB(38, 38, 60))
            HoverEffect(Btn, function() return T.BG_ELEMENT end, function() return T.BG_HOVER end)
            OnThemeChange(function(theme) Btn.BackgroundColor3 = theme.BG_ELEMENT end)

            MakeTitleLabel(Btn, text, hasDesc, 20)
            if hasDesc then MakeDescLabel(Btn, cfg3.Desc) end

            Btn.MouseButton1Click:Connect(function()
                Tween(Btn, {BackgroundColor3 = T.ACCENT_DARK}, 0.08)
                task.delay(0.12, function() Tween(Btn, {BackgroundColor3 = T.BG_ELEMENT}, 0.15) end)
                if callback then callback() end
                SetStatus(text)
            end)

            table.insert(allSearchItems, {
                title  = text,
                kind   = "Button",
                jumpFn = function() Activate() end
            })

            return Btn
        end

        function Tab:Slider(cfg3)
            local text     = cfg3.Title    or "Slider"
            local callback = cfg3.Callback
            local valCfg   = cfg3.Value    or {}
            local minV     = valCfg.Min    or 0
            local maxV     = valCfg.Max    or 100
            local step     = cfg3.Step     or 1
            local value    = math.clamp(valCfg.Default or minV, minV, maxV)
            local hasDesc  = cfg3.Desc     ~= nil

            local Row = MakeRow(hasDesc and 62 or 54, NextOrder())
            MakeTitleLabel(Row, text, false, 68)

            if hasDesc then MakeDescLabel(Row, cfg3.Desc, 24) end

            local ValBox            = Instance.new("TextBox")
            ValBox.Size             = UDim2.new(0, 54, 0, 22)
            ValBox.Position         = UDim2.new(1, -60, 0, 3)
            ValBox.BackgroundColor3 = Color3.fromRGB(24, 24, 42)
            ValBox.Text             = tostring(value)
            ValBox.TextColor3       = T.ACCENT
            ValBox.Font             = Enum.Font.GothamBold
            ValBox.TextSize         = 12
            ValBox.TextXAlignment   = Enum.TextXAlignment.Center
            ValBox.ClearTextOnFocus = true
            ValBox.ZIndex           = 4
            ValBox.Parent           = Row
            Corner(ValBox, UDim.new(0, 5))
            Stroke(ValBox, Color3.fromRGB(55, 55, 90), 1)
            ValBox.Focused:Connect(function() Tween(ValBox, {BackgroundColor3 = Color3.fromRGB(34, 34, 60)}, 0.1) end)
            OnThemeChange(function(theme) ValBox.TextColor3 = theme.ACCENT end)
            OnFontScaleChange(function(s) ValBox.TextSize = math.floor(12 * s) end)

            local trackY            = hasDesc and 46 or 39
            local Track             = Instance.new("Frame")
            Track.Size              = UDim2.new(1, -24, 0, 5)
            Track.Position          = UDim2.new(0, 12, 0, trackY)
            Track.BackgroundColor3  = Color3.fromRGB(38, 38, 60)
            Track.BorderSizePixel   = 0
            Track.Parent            = Row
            Corner(Track, UDim.new(1, 0))

            local Fill              = Instance.new("Frame")
            Fill.Size               = UDim2.new((value - minV) / (maxV - minV), 0, 1, 0)
            Fill.BackgroundColor3   = T.ACCENT
            Fill.BorderSizePixel    = 0
            Fill.Parent             = Track
            Corner(Fill, UDim.new(1, 0))
            OnThemeChange(function(theme) Fill.BackgroundColor3 = theme.ACCENT end)

            local FG                = Instance.new("UIGradient")
            FG.Color                = ColorSequence.new({
                ColorSequenceKeypoint.new(0, T.ACCENT),
                ColorSequenceKeypoint.new(1, T.ACCENT_DARK),
            })
            FG.Parent               = Fill
            OnThemeChange(function(theme)
                FG.Color = ColorSequence.new({
                    ColorSequenceKeypoint.new(0, theme.ACCENT),
                    ColorSequenceKeypoint.new(1, theme.ACCENT_DARK),
                })
            end)

            local Thumb             = Instance.new("Frame")
            Thumb.Size              = UDim2.new(0, 14, 0, 14)
            Thumb.Position          = UDim2.new((value - minV) / (maxV - minV), -7, 0.5, -7)
            Thumb.BackgroundColor3  = Color3.new(1, 1, 1)
            Thumb.ZIndex            = 3
            Thumb.Parent            = Track
            Corner(Thumb, UDim.new(1, 0))

            local function ApplyValue(v)
                local snapped = math.floor((v - minV) / step + 0.5) * step + minV
                value = math.clamp(snapped, minV, maxV)
                if step >= 1 then
                    value = math.floor(value + 0.5)
                else
                    local dec = math.ceil(-math.log10(step))
                    value = math.floor(value * 10 ^ dec + 0.5) / 10 ^ dec
                end
                local pct       = (value - minV) / (maxV - minV)
                ValBox.Text     = tostring(value)
                Fill.Size       = UDim2.new(pct, 0, 1, 0)
                Thumb.Position  = UDim2.new(pct, -7, 0.5, -7)
                if callback then callback(value) end
            end

            ValBox.FocusLost:Connect(function()
                Tween(ValBox, {BackgroundColor3 = Color3.fromRGB(24, 24, 42)}, 0.1)
                local t = tonumber(ValBox.Text)
                if t then ApplyValue(t) else ValBox.Text = tostring(value) end
            end)

            local dragging   = false
            local SliderBtn  = Instance.new("TextButton")
            SliderBtn.Size   = UDim2.new(1, 0, 0, 20)
            SliderBtn.Position = UDim2.new(0, 0, 0.5, -10)
            SliderBtn.BackgroundTransparency = 1
            SliderBtn.Text   = ""
            SliderBtn.ZIndex = 5
            SliderBtn.Parent = Track

            local function UpdateFromX(x)
                ApplyValue(minV + (maxV - minV) * math.clamp(
                    (x - Track.AbsolutePosition.X) / Track.AbsoluteSize.X, 0, 1))
            end
            SliderBtn.InputBegan:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true; UpdateFromX(i.Position.X)
                end
            end)
            UserInputService.InputChanged:Connect(function(i)
                if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
                    UpdateFromX(i.Position.X)
                end
            end)
            UserInputService.InputEnded:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
            end)

            table.insert(allSearchItems, {
                title  = text,
                kind   = "Slider",
                jumpFn = function() Activate() end
            })

            local ctrl = {}
            function ctrl:Set(v) ApplyValue(v) end
            function ctrl:Get() return value     end
            return ctrl
        end

        function Tab:Keybind(cfg3)
            local text      = cfg3.Title    or "Keybind"
            local callback  = cfg3.Callback
            local current   = Enum.KeyCode[cfg3.Value or "F"] or Enum.KeyCode.F
            local listening = false
            local hasDesc   = cfg3.Desc     ~= nil

            local Row = MakeRow(hasDesc and 46 or 38, NextOrder())
            HoverEffect(Row, function() return T.BG_ELEMENT end, function() return T.BG_HOVER end)
            MakeTitleLabel(Row, text, hasDesc, 90)
            if hasDesc then MakeDescLabel(Row, cfg3.Desc) end

            local BindPill              = Instance.new("TextButton")
            BindPill.Size               = UDim2.new(0, 76, 0, 24)
            BindPill.Position           = UDim2.new(1, -82, 0.5, -12)
            BindPill.BackgroundColor3   = Color3.fromRGB(28, 28, 48)
            BindPill.Text               = current.Name
            BindPill.TextColor3         = T.ACCENT
            BindPill.Font               = Enum.Font.GothamBold
            BindPill.TextSize           = 11
            BindPill.Parent             = Row
            Corner(BindPill, UDim.new(0, 5))
            Stroke(BindPill, Color3.fromRGB(60, 60, 100))
            OnThemeChange(function(theme) BindPill.TextColor3 = theme.ACCENT end)
            OnFontScaleChange(function(s) BindPill.TextSize = math.floor(11 * s) end)

            BindPill.MouseButton1Click:Connect(function()
                listening           = true
                BindPill.Text       = "..."
                BindPill.TextColor3 = Color3.fromRGB(255, 200, 50)
            end)
            UserInputService.InputBegan:Connect(function(io, gpe)
                if listening and not gpe and io.UserInputType == Enum.UserInputType.Keyboard then
                    current             = io.KeyCode
                    listening           = false
                    BindPill.Text       = current.Name
                    BindPill.TextColor3 = T.ACCENT
                    if callback then callback(current.Name) end
                elseif not gpe and io.KeyCode == current and not listening then
                    if callback then callback(current.Name) end
                    SetStatus(text .. " triggered")
                end
            end)

            table.insert(allSearchItems, {
                title  = text,
                kind   = "Keybind",
                jumpFn = function() Activate() end
            })

            local ctrl = {}
            function ctrl:Get() return current end
            return ctrl
        end

        function Tab:Input(cfg3)
            local text     = cfg3.Title    or "Input"
            local callback = cfg3.Callback
            local isArea   = cfg3.Type     == "Textarea"
            local hasDesc  = cfg3.Desc     ~= nil
            local rowH     = isArea and 80 or (hasDesc and 62 or 52)

            local Row = MakeRow(rowH, NextOrder())
            MakeTitleLabel(Row, text, true, 20)
            if hasDesc then MakeDescLabel(Row, cfg3.Desc) end

            local inputY            = hasDesc and 38 or 28
            local InputBox          = Instance.new("TextBox")
            InputBox.Size           = UDim2.new(1, -24, 0, isArea and 44 or 22)
            InputBox.Position       = UDim2.new(0, 12, 0, inputY)
            InputBox.BackgroundColor3 = Color3.fromRGB(20, 20, 34)
            InputBox.PlaceholderText= cfg3.Placeholder or "Type here..."
            InputBox.PlaceholderColor3 = T.TEXT_DIM
            InputBox.Text           = cfg3.Value or ""
            InputBox.TextColor3     = T.TEXT_MAIN
            InputBox.Font           = Enum.Font.Gotham
            InputBox.TextSize       = 12
            InputBox.TextXAlignment = Enum.TextXAlignment.Left
            InputBox.MultiLine      = isArea
            InputBox.ClearTextOnFocus = false
            InputBox.ZIndex         = 3
            InputBox.Parent         = Row
            Corner(InputBox, UDim.new(0, 5))
            Stroke(InputBox, Color3.fromRGB(48, 48, 75), 1)
            OnThemeChange(function(theme)
                InputBox.TextColor3       = theme.TEXT_MAIN
                InputBox.PlaceholderColor3= theme.TEXT_DIM
            end)
            OnFontScaleChange(function(s) InputBox.TextSize = math.floor(12 * s) end)

            local IP                = Instance.new("UIPadding")
            IP.PaddingLeft          = UDim.new(0, 8)
            IP.Parent               = InputBox

            InputBox.Focused:Connect(function() Tween(InputBox, {BackgroundColor3 = Color3.fromRGB(28, 28, 48)}, 0.1) end)
            InputBox.FocusLost:Connect(function()
                Tween(InputBox, {BackgroundColor3 = Color3.fromRGB(20, 20, 34)}, 0.1)
                if callback then callback(InputBox.Text) end
                SetStatus(text .. " updated")
            end)

            table.insert(allSearchItems, {
                title  = text,
                kind   = "Input",
                jumpFn = function() Activate() end
            })

            local ctrl = {}
            function ctrl:Get() return InputBox.Text end
            function ctrl:Set(v) InputBox.Text = v    end
            return ctrl
        end

        function Tab:Dropdown(cfg3)
            local text          = cfg3.Title    or "Dropdown"
            local options       = cfg3.Values   or {}
            local callback      = cfg3.Callback
            local isMulti       = cfg3.Multi    == true
            local ITEM_H        = 30
            local hasDesc       = cfg3.Desc     ~= nil
            local baseH         = hasDesc and 46 or 38

            local selected
            if isMulti then
                selected = {}
                if type(cfg3.Value) == "table" then
                    for _, v in ipairs(cfg3.Value) do selected[v] = true end
                end
            else
                selected = cfg3.Value or options[1]
            end

            local open           = false
            local currentOptions = {}
            for _, v in ipairs(options) do table.insert(currentOptions, v) end

            local Wrapper                       = Instance.new("Frame")
            Wrapper.Size                        = UDim2.new(1, 0, 0, baseH)
            Wrapper.BackgroundTransparency      = 1
            Wrapper.ClipsDescendants            = false
            Wrapper.LayoutOrder                 = NextOrder()
            Wrapper.ZIndex                      = 20
            Wrapper.Parent                      = Page

            local Header                        = Instance.new("Frame")
            Header.Size                         = UDim2.new(1, 0, 0, baseH)
            Header.BackgroundColor3             = T.BG_ELEMENT
            Header.BorderSizePixel              = 0
            Header.ZIndex                       = 21
            Header.Parent                       = Wrapper
            Corner(Header, UDim.new(0, 7))
            Stroke(Header, Color3.fromRGB(38, 38, 60))
            HoverEffect(Header, function() return T.BG_ELEMENT end, function() return T.BG_HOVER end)
            OnThemeChange(function(theme) Header.BackgroundColor3 = theme.BG_ELEMENT end)

            MakeTitleLabel(Header, text, hasDesc, isMulti and 130 or 105).ZIndex = 22
            if hasDesc then MakeDescLabel(Header, cfg3.Desc).ZIndex = 22 end

            local MultiBadge, MultiBadgeLbl
            if isMulti then
                MultiBadge                      = Instance.new("Frame")
                MultiBadge.Size                 = UDim2.new(0, 20, 0, 20)
                MultiBadge.Position             = UDim2.new(1, -30, 0.5, -10)
                MultiBadge.BackgroundColor3     = Color3.fromRGB(38, 38, 65)
                MultiBadge.ZIndex               = 24
                MultiBadge.Parent               = Header
                Corner(MultiBadge, UDim.new(1, 0))
                Stroke(MultiBadge, Color3.fromRGB(70, 70, 110), 1)

                MultiBadgeLbl                   = Instance.new("TextLabel")
                MultiBadgeLbl.Size              = UDim2.new(1, 0, 1, 0)
                MultiBadgeLbl.BackgroundTransparency = 1
                MultiBadgeLbl.Text              = "0"
                MultiBadgeLbl.TextColor3        = T.TEXT_DIM
                MultiBadgeLbl.Font              = Enum.Font.GothamBold
                MultiBadgeLbl.TextSize          = 10
                MultiBadgeLbl.ZIndex            = 25
                MultiBadgeLbl.Parent            = MultiBadge
                OnThemeChange(function(theme) MultiBadgeLbl.TextColor3 = theme.TEXT_DIM end)
            end

            local ValPill                       = Instance.new("Frame")
            ValPill.Size                        = UDim2.new(0, 86, 0, 24)
            ValPill.Position                    = UDim2.new(1, isMulti and -120 or -92, 0.5, -12)
            ValPill.BackgroundColor3            = Color3.fromRGB(24, 24, 42)
            ValPill.ZIndex                      = 22
            ValPill.Parent                      = Header
            Corner(ValPill, UDim.new(0, 5))
            Stroke(ValPill, Color3.fromRGB(55, 55, 90), 1)

            local ValLbl                        = Instance.new("TextLabel")
            ValLbl.Size                         = UDim2.new(1, -16, 1, 0)
            ValLbl.Position                     = UDim2.new(0, 6, 0, 0)
            ValLbl.BackgroundTransparency       = 1
            ValLbl.TextColor3                   = T.ACCENT
            ValLbl.Font                         = Enum.Font.GothamBold
            ValLbl.TextSize                     = 10
            ValLbl.TextXAlignment               = Enum.TextXAlignment.Left
            ValLbl.TextTruncate                 = Enum.TextTruncate.AtEnd
            ValLbl.ZIndex                       = 23
            ValLbl.Parent                       = ValPill
            OnThemeChange(function(theme) ValLbl.TextColor3 = theme.ACCENT end)

            local Arrow                         = Instance.new("TextLabel")
            Arrow.Size                          = UDim2.new(0, 12, 1, 0)
            Arrow.Position                      = UDim2.new(1, -13, 0, 0)
            Arrow.BackgroundTransparency        = 1
            Arrow.Text                          = "v"
            Arrow.TextColor3                    = T.TEXT_DIM
            Arrow.Font                          = Enum.Font.GothamBold
            Arrow.TextSize                      = 9
            Arrow.ZIndex                        = 23
            Arrow.Parent                        = ValPill
            OnThemeChange(function(theme) Arrow.TextColor3 = theme.TEXT_DIM end)

            local HeaderBtn                     = Instance.new("TextButton")
            HeaderBtn.Size                      = UDim2.new(1, 0, 1, 0)
            HeaderBtn.BackgroundTransparency    = 1
            HeaderBtn.Text                      = ""
            HeaderBtn.ZIndex                    = 24
            HeaderBtn.Parent                    = Header

            local ListScroll                    = Instance.new("ScrollingFrame")
            ListScroll.Size                     = UDim2.new(1, 0, 0, ITEM_H * math.min(#currentOptions, 6) + 6)
            ListScroll.Position                 = UDim2.new(0, 0, 0, baseH + 4)
            ListScroll.BackgroundColor3         = T.BG_PANEL
            ListScroll.BorderSizePixel          = 0
            ListScroll.Visible                  = false
            ListScroll.ZIndex                   = 30
            ListScroll.ScrollBarThickness       = 3
            ListScroll.ScrollBarImageColor3     = T.ACCENT
            ListScroll.CanvasSize               = UDim2.new(0, 0, 0, 0)
            ListScroll.Parent                   = Wrapper
            Corner(ListScroll, UDim.new(0, 7))
            Stroke(ListScroll, Color3.fromRGB(48, 48, 76), 1)
            OnThemeChange(function(theme)
                ListScroll.BackgroundColor3      = theme.BG_PANEL
                ListScroll.ScrollBarImageColor3  = theme.ACCENT
            end)

            local ListLayout                    = Instance.new("UIListLayout")
            ListLayout.Padding                  = UDim.new(0, 2)
            ListLayout.Parent                   = ListScroll
            local LP                            = Instance.new("UIPadding")
            LP.PaddingLeft                      = UDim.new(0, 4)
            LP.PaddingRight                     = UDim.new(0, 4)
            LP.PaddingTop                       = UDim.new(0, 3)
            LP.PaddingBottom                    = UDim.new(0, 3)
            LP.Parent                           = ListScroll

            ListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                ListScroll.CanvasSize = UDim2.new(0, 0, 0, ListLayout.AbsoluteContentSize.Y + 6)
            end)

            local function UpdateValLabel()
                if isMulti then
                    local count, parts = 0, {}
                    for k, v in pairs(selected) do
                        if v then count += 1; table.insert(parts, tostring(k)) end
                    end
                    ValLbl.Text       = count == 0 and "none" or table.concat(parts, ", ")
                    ValLbl.TextColor3 = count == 0 and T.TEXT_DIM or T.ACCENT
                    if MultiBadge and MultiBadgeLbl then
                        MultiBadgeLbl.Text      = tostring(count)
                        MultiBadgeLbl.TextColor3= count > 0 and Color3.new(1,1,1) or T.TEXT_DIM
                        Tween(MultiBadge, {BackgroundColor3 = count > 0 and T.ACCENT or Color3.fromRGB(38,38,65)}, 0.12)
                    end
                else
                    ValLbl.Text       = selected ~= nil and tostring(selected) or "none"
                    ValLbl.TextColor3 = selected ~= nil and T.ACCENT or T.TEXT_DIM
                end
            end

            local itemRows = {}

            local function BuildItem(opt)
                local isSel = isMulti and (selected[opt] == true) or (selected == opt)

                local Item                      = Instance.new("TextButton")
                Item.Size                       = UDim2.new(1, 0, 0, ITEM_H - 2)
                Item.BackgroundColor3           = isSel and Color3.fromRGB(30,30,52) or T.BG_ELEMENT
                Item.Text                       = ""
                Item.ZIndex                     = 31
                Item.Parent                     = ListScroll
                Corner(Item, UDim.new(0, 5))
                OnThemeChange(function(theme)
                    if not (isMulti and selected[opt] or selected == opt) then
                        Item.BackgroundColor3 = theme.BG_ELEMENT
                    end
                end)

                local ItemLbl                   = Instance.new("TextLabel")
                ItemLbl.Size                    = UDim2.new(1, -34, 1, 0)
                ItemLbl.Position                = UDim2.new(0, 10, 0, 0)
                ItemLbl.BackgroundTransparency  = 1
                ItemLbl.Text                    = tostring(opt)
                ItemLbl.TextColor3              = isSel and T.TEXT_MAIN or T.TEXT_DIM
                ItemLbl.Font                    = Enum.Font.Gotham
                ItemLbl.TextSize                = 12
                ItemLbl.TextXAlignment          = Enum.TextXAlignment.Left
                ItemLbl.ZIndex                  = 32
                ItemLbl.Parent                  = Item
                OnThemeChange(function(theme)
                    ItemLbl.TextColor3 = (isMulti and selected[opt] or selected == opt) and theme.TEXT_MAIN or theme.TEXT_DIM
                end)
                OnFontScaleChange(function(s) ItemLbl.TextSize = math.floor(12 * s) end)

                local Check                     = Instance.new("Frame")
                Check.Size                      = UDim2.new(0, 16, 0, 16)
                Check.Position                  = UDim2.new(1, -24, 0.5, -8)
                Check.BackgroundColor3          = isSel and T.ACCENT or Color3.fromRGB(38,38,58)
                Check.ZIndex                    = 32
                Check.Parent                    = Item
                Corner(Check, UDim.new(isMulti and 0.2 or 1, 0))
                Stroke(Check, Color3.fromRGB(60,60,90), 1)
                OnThemeChange(function(theme)
                    Check.BackgroundColor3 = (isMulti and selected[opt] or selected == opt) and theme.ACCENT or Color3.fromRGB(38,38,58)
                end)

                local CheckMark                 = Instance.new("TextLabel")
                CheckMark.Size                  = UDim2.new(1, 0, 1, 0)
                CheckMark.BackgroundTransparency= 1
                CheckMark.Text                  = "v"
                CheckMark.TextColor3            = Color3.new(1,1,1)
                CheckMark.Font                  = Enum.Font.GothamBold
                CheckMark.TextSize              = 9
                CheckMark.Visible               = isSel
                CheckMark.ZIndex                = 33
                CheckMark.Parent                = Check

                Item.MouseEnter:Connect(function() Tween(Item, {BackgroundColor3 = T.BG_HOVER}, 0.12) end)
                Item.MouseLeave:Connect(function()
                    Tween(Item, {BackgroundColor3 = (isMulti and selected[opt] or selected == opt) and Color3.fromRGB(30,30,52) or T.BG_ELEMENT}, 0.15)
                end)

                Item.MouseButton1Click:Connect(function()
                    if isMulti then
                        selected[opt] = not selected[opt] or nil
                        local nowSel  = selected[opt] == true
                        Tween(Check, {BackgroundColor3 = nowSel and T.ACCENT or Color3.fromRGB(38,38,58)}, 0.1)
                        CheckMark.Visible    = nowSel
                        ItemLbl.TextColor3   = nowSel and T.TEXT_MAIN or T.TEXT_DIM
                        Tween(Item, {BackgroundColor3 = nowSel and Color3.fromRGB(30,30,52) or T.BG_ELEMENT}, 0.1)
                        UpdateValLabel()
                        if callback then
                            local r = {}
                            for k, v in pairs(selected) do if v then table.insert(r, k) end end
                            callback(r)
                        end
                        local count = 0
                        for _, v in pairs(selected) do if v then count += 1 end end
                        SetStatus(text .. ": " .. count .. " selected")
                    else
                        if itemRows[selected] then
                            local old = itemRows[selected]
                            Tween(old.check,    {BackgroundColor3 = Color3.fromRGB(38,38,58)}, 0.1)
                            old.checkmark.Visible = false
                            old.lbl.TextColor3    = T.TEXT_DIM
                            Tween(old.item,     {BackgroundColor3 = T.BG_ELEMENT}, 0.1)
                        end
                        selected = opt
                        Tween(Check,  {BackgroundColor3 = T.ACCENT}, 0.1)
                        CheckMark.Visible  = true
                        ItemLbl.TextColor3 = T.TEXT_MAIN
                        Tween(Item,  {BackgroundColor3 = Color3.fromRGB(30,30,52)}, 0.1)
                        UpdateValLabel()
                        open = false; ListScroll.Visible = false
                        Wrapper.Size = UDim2.new(1, 0, 0, baseH)
                        Tween(Arrow, {Rotation = 0}, 0.15); Wrapper.ZIndex = 20
                        if callback then callback(selected) end
                        SetStatus(text .. ": " .. tostring(selected))
                    end
                end)

                itemRows[opt] = {item = Item, lbl = ItemLbl, check = Check, checkmark = CheckMark}
            end

            for _, opt in ipairs(currentOptions) do BuildItem(opt) end
            UpdateValLabel()

            local function CalcListH()
                return ITEM_H * math.min(#currentOptions, 6) + 6
            end

            local function Close()
                open = false; ListScroll.Visible = false
                Wrapper.Size = UDim2.new(1, 0, 0, baseH)
                Tween(Arrow, {Rotation = 0}, 0.15); Wrapper.ZIndex = 20
            end

            local function Open()
                open = true
                ListScroll.Size    = UDim2.new(1, 0, 0, CalcListH())
                ListScroll.Visible = true; Wrapper.ZIndex = 50
                Tween(Wrapper,  {Size = UDim2.new(1, 0, 0, baseH + CalcListH() + 4)}, 0.18)
                Tween(Arrow, {Rotation = 180}, 0.18)
            end

            HeaderBtn.MouseButton1Click:Connect(function()
                if open then Close() else Open() end
            end)

            table.insert(allSearchItems, {
                title  = text,
                kind   = "Dropdown",
                jumpFn = function() Activate() end
            })

            local ctrl = {}
            function ctrl:Get()
                if isMulti then
                    local r = {}
                    for k, v in pairs(selected) do if v then table.insert(r, k) end end
                    return r
                else
                    return selected
                end
            end

            function ctrl:Set(v)
                if isMulti then
                    selected = {}
                    if type(v) == "table" then
                        for _, i in ipairs(v) do selected[i] = true end
                    end
                    for opt, row in pairs(itemRows) do
                        local ns = selected[opt] == true
                        row.check.BackgroundColor3 = ns and T.ACCENT or Color3.fromRGB(38,38,58)
                        row.checkmark.Visible      = ns
                        row.lbl.TextColor3         = ns and T.TEXT_MAIN or T.TEXT_DIM
                        row.item.BackgroundColor3  = ns and Color3.fromRGB(30,30,52) or T.BG_ELEMENT
                    end
                else
                    if itemRows[selected] then
                        itemRows[selected].check.BackgroundColor3 = Color3.fromRGB(38,38,58)
                        itemRows[selected].checkmark.Visible      = false
                        itemRows[selected].lbl.TextColor3         = T.TEXT_DIM
                        itemRows[selected].item.BackgroundColor3  = T.BG_ELEMENT
                    end
                    selected = v
                    if itemRows[v] then
                        itemRows[v].check.BackgroundColor3 = T.ACCENT
                        itemRows[v].checkmark.Visible      = true
                        itemRows[v].lbl.TextColor3         = T.TEXT_MAIN
                        itemRows[v].item.BackgroundColor3  = Color3.fromRGB(30,30,52)
                    end
                end
                UpdateValLabel()
            end

            function ctrl:Add(opt)
                if itemRows[opt] then return end
                table.insert(currentOptions, opt); BuildItem(opt)
                if open then
                    ListScroll.Size = UDim2.new(1, 0, 0, CalcListH())
                    Wrapper.Size    = UDim2.new(1, 0, 0, baseH + CalcListH() + 4)
                end
            end

            function ctrl:Remove(opt)
                if not itemRows[opt] then return end
                if isMulti then selected[opt] = nil
                elseif selected == opt then selected = nil; UpdateValLabel() end
                itemRows[opt].item:Destroy(); itemRows[opt] = nil
                for i, v in ipairs(currentOptions) do
                    if v == opt then table.remove(currentOptions, i); break end
                end
                if open then
                    ListScroll.Size = UDim2.new(1, 0, 0, CalcListH())
                    Wrapper.Size    = UDim2.new(1, 0, 0, baseH + CalcListH() + 4)
                end
                UpdateValLabel()
            end

            function ctrl:Refresh(newOptions)
                for _, row in pairs(itemRows) do row.item:Destroy() end
                itemRows = {}; currentOptions = {}
                selected  = isMulti and {} or nil
                for _, opt in ipairs(newOptions) do
                    table.insert(currentOptions, opt); BuildItem(opt)
                end
                if open then
                    ListScroll.Size = UDim2.new(1, 0, 0, CalcListH())
                    Wrapper.Size    = UDim2.new(1, 0, 0, baseH + CalcListH() + 4)
                else
                    Close()
                end
                UpdateValLabel()
            end

            return ctrl
        end

        -- -------------------------------------------------------
        -- COLORPICKER
        -- -------------------------------------------------------
        -- Usage:
        --   local cp = Tab:Colorpicker({
        --     Title = "Background Color",
        --     Desc  = "Pick a color",
        --     Default = Color3.fromRGB(0, 255, 0),
        --     Transparency = 0,   -- 0-1, optional
        --     Locked = false,
        --     Callback = function(color, transparency) end
        --   })
        --   cp:Set(Color3.fromRGB(255,0,0))
        --   cp:Get()  --> Color3
        function Tab:Colorpicker(cfg3)
            local text     = cfg3.Title        or "Colorpicker"
            local callback = cfg3.Callback
            local hasDesc  = cfg3.Desc         ~= nil
            local locked   = cfg3.Locked       == true
            local current  = cfg3.Default      or Color3.fromRGB(255, 255, 255)
            local alpha    = math.clamp(1 - (cfg3.Transparency or 0), 0, 1)

            local baseH    = hasDesc and 46 or 38
            local Row      = MakeRow(baseH, NextOrder())
            HoverEffect(Row, function() return T.BG_ELEMENT end, function() return T.BG_HOVER end)
            MakeTitleLabel(Row, text, hasDesc, 80)
            if hasDesc then MakeDescLabel(Row, cfg3.Desc) end

            -- Swatch button
            local Swatch                    = Instance.new("TextButton")
            Swatch.Size                     = UDim2.new(0, 54, 0, 24)
            Swatch.Position                 = UDim2.new(1, -62, 0.5, -12)
            Swatch.BackgroundColor3         = current
            Swatch.Text                     = ""
            Swatch.ZIndex                   = 4
            Swatch.Parent                   = Row
            Corner(Swatch, UDim.new(0, 5))
            Stroke(Swatch, Color3.fromRGB(60, 60, 100), 1)

            -- Checkerboard overlay for transparency hint
            local CheckerA                  = Instance.new("UIGradient")
            CheckerA.Color                  = ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.new(1,1,1)),
                ColorSequenceKeypoint.new(1, Color3.new(0,0,0)),
            })
            CheckerA.Transparency           = NumberSequence.new(1 - alpha)
            CheckerA.Parent                 = Swatch

            local pickerOpen = false

            -- Picker popup
            local Popup                     = Instance.new("Frame")
            Popup.Size                      = UDim2.new(0, 220, 0, 0)
            Popup.Position                  = UDim2.new(1, -224, 1, 6)
            Popup.BackgroundColor3          = T.BG_PANEL
            Popup.BorderSizePixel           = 0
            Popup.Visible                   = false
            Popup.ZIndex                    = 80
            Popup.ClipsDescendants          = false
            Popup.AutomaticSize             = Enum.AutomaticSize.Y
            Popup.Parent                    = Row
            Corner(Popup, UDim.new(0, 10))
            Stroke(Popup, Color3.fromRGB(55, 55, 85), 1)
            OnThemeChange(function(theme) Popup.BackgroundColor3 = theme.BG_PANEL end)

            local PopPad                    = Instance.new("UIPadding")
            PopPad.PaddingLeft              = UDim.new(0, 10)
            PopPad.PaddingRight             = UDim.new(0, 10)
            PopPad.PaddingTop               = UDim.new(0, 10)
            PopPad.PaddingBottom            = UDim.new(0, 10)
            PopPad.Parent                   = Popup

            local PopLayout                 = Instance.new("UIListLayout")
            PopLayout.Padding               = UDim.new(0, 8)
            PopLayout.Parent                = Popup

            -- Hue / Saturation / Value sliders
            local function MakeSlider(labelTxt, defaultVal)
                local wrap              = Instance.new("Frame")
                wrap.Size               = UDim2.new(1, 0, 0, 36)
                wrap.BackgroundTransparency = 1
                wrap.ZIndex             = 81
                wrap.Parent             = Popup
                local lbl               = Instance.new("TextLabel")
                lbl.Size                = UDim2.new(1, -42, 0, 14)
                lbl.BackgroundTransparency = 1
                lbl.Text                = labelTxt
                lbl.TextColor3          = T.TEXT_DIM
                lbl.Font                = Enum.Font.GothamBold
                lbl.TextSize            = 9
                lbl.TextXAlignment      = Enum.TextXAlignment.Left
                lbl.ZIndex              = 82
                lbl.Parent              = wrap
                OnThemeChange(function(theme) lbl.TextColor3 = theme.TEXT_DIM end)
                local valBox            = Instance.new("TextBox")
                valBox.Size             = UDim2.new(0, 38, 0, 14)
                valBox.Position         = UDim2.new(1, -38, 0, 0)
                valBox.BackgroundColor3 = Color3.fromRGB(24, 24, 42)
                valBox.Text             = tostring(math.floor(defaultVal * 255 + 0.5))
                valBox.TextColor3       = T.ACCENT
                valBox.Font             = Enum.Font.GothamBold
                valBox.TextSize         = 9
                valBox.TextXAlignment   = Enum.TextXAlignment.Center
                valBox.ClearTextOnFocus = true
                valBox.ZIndex           = 82
                valBox.Parent           = wrap
                Corner(valBox, UDim.new(0, 3))
                OnThemeChange(function(theme) valBox.TextColor3 = theme.ACCENT end)
                local track             = Instance.new("Frame")
                track.Size              = UDim2.new(1, 0, 0, 10)
                track.Position          = UDim2.new(0, 0, 0, 18)
                track.BackgroundColor3  = Color3.fromRGB(38, 38, 60)
                track.BorderSizePixel   = 0
                track.ZIndex            = 82
                track.Parent            = wrap
                Corner(track, UDim.new(1, 0))
                local fill              = Instance.new("Frame")
                fill.Size               = UDim2.new(defaultVal, 0, 1, 0)
                fill.BackgroundColor3   = T.ACCENT
                fill.BorderSizePixel    = 0
                fill.ZIndex             = 83
                fill.Parent             = track
                Corner(fill, UDim.new(1, 0))
                OnThemeChange(function(theme) fill.BackgroundColor3 = theme.ACCENT end)
                local thumb             = Instance.new("Frame")
                thumb.Size              = UDim2.new(0, 12, 0, 12)
                thumb.Position          = UDim2.new(defaultVal, -6, 0.5, -6)
                thumb.BackgroundColor3  = Color3.new(1, 1, 1)
                thumb.ZIndex            = 84
                thumb.Parent            = track
                Corner(thumb, UDim.new(1, 0))
                local value = defaultVal
                local function SetVal(v)
                    value = math.clamp(v, 0, 1)
                    fill.Size     = UDim2.new(value, 0, 1, 0)
                    thumb.Position= UDim2.new(value, -6, 0.5, -6)
                    valBox.Text   = tostring(math.floor(value * 255 + 0.5))
                end
                local trackBtn          = Instance.new("TextButton")
                trackBtn.Size           = UDim2.new(1, 0, 0, 20)
                trackBtn.Position       = UDim2.new(0, 0, 0.5, -10)
                trackBtn.BackgroundTransparency = 1
                trackBtn.Text           = ""
                trackBtn.ZIndex         = 85
                trackBtn.Parent         = track
                local draggingS = false
                trackBtn.InputBegan:Connect(function(i)
                    if i.UserInputType == Enum.UserInputType.MouseButton1 then
                        draggingS = true
                        SetVal(math.clamp((i.Position.X - track.AbsolutePosition.X) / track.AbsoluteSize.X, 0, 1))
                    end
                end)
                UserInputService.InputChanged:Connect(function(i)
                    if draggingS and i.UserInputType == Enum.UserInputType.MouseMovement then
                        SetVal(math.clamp((i.Position.X - track.AbsolutePosition.X) / track.AbsoluteSize.X, 0, 1))
                    end
                end)
                UserInputService.InputEnded:Connect(function(i)
                    if i.UserInputType == Enum.UserInputType.MouseButton1 then draggingS = false end
                end)
                valBox.FocusLost:Connect(function()
                    local n = tonumber(valBox.Text)
                    if n then SetVal(n / 255) end
                end)
                return {
                    GetValue = function() return value end,
                    SetValue = SetVal,
                }
            end

            -- Decompose current color to R,G,B 0-1
            local r0 = current.R
            local g0 = current.G
            local b0 = current.B

            local sliderR = MakeSlider("R", r0)
            local sliderG = MakeSlider("G", g0)
            local sliderB = MakeSlider("B", b0)

            -- Transparency slider (only if Transparency was provided)
            local sliderA
            if cfg3.Transparency ~= nil then
                sliderA = MakeSlider("A", alpha)
            end

            -- Preview swatch in popup
            local PreviewSwatch             = Instance.new("Frame")
            PreviewSwatch.Size              = UDim2.new(1, 0, 0, 20)
            PreviewSwatch.BackgroundColor3  = current
            PreviewSwatch.BorderSizePixel   = 0
            PreviewSwatch.ZIndex            = 81
            PreviewSwatch.Parent            = Popup
            Corner(PreviewSwatch, UDim.new(0, 5))

            local function UpdateColor()
                current = Color3.new(
                    sliderR.GetValue(),
                    sliderG.GetValue(),
                    sliderB.GetValue()
                )
                alpha = sliderA and sliderA.GetValue() or alpha
                Tween(Swatch,        {BackgroundColor3 = current}, 0.05)
                Tween(PreviewSwatch, {BackgroundColor3 = current}, 0.05)
                if callback then callback(current, 1 - alpha) end
                SetStatus(text .. " updated")
            end

            -- Wire up slider callbacks to UpdateColor
            -- We'll patch the trackBtn InputEnded and valBox FocusLost via a simple approach:
            -- Re-connect after creation by monkey-patching the setval calls.
            -- Instead, re-create sliders with callback wired in.
            -- (Sliders above already call SetVal; we connect via UserInputService.InputEnded on each)
            -- Simpler: poll via InputEnded on the whole popup area
            local function WireUpdate(slider)
                -- Not straightforward to intercept the closure, so we use a changed signal approach
                -- We'll just fire UpdateColor on every UserInputService.InputEnded inside popup
            end

            -- Use a single global connect per picker that fires update on mouse release or FocusLost
            local function PickerInputEnded(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 then
                    task.defer(UpdateColor)
                end
            end
            Popup.InputEnded:Connect(PickerInputEnded)
            -- Also fire on each valBox FocusLost (already handled by sliders' valBox.FocusLost which calls SetVal,
            -- but doesn't call UpdateColor; add a secondary connection via a small wrapper)
            -- The simplest fix: after each slider's trackBtn InputEnded fires UpdateColor too.
            -- This is taken care of by Popup.InputEnded which covers all children.

            if not locked then
                Swatch.MouseButton1Click:Connect(function()
                    pickerOpen = not pickerOpen
                    Popup.Visible = pickerOpen
                    if pickerOpen then
                        Tween(Popup, {BackgroundColor3 = T.BG_PANEL}, 0)
                    end
                end)
            end

            -- Close when clicking outside
            UserInputService.InputBegan:Connect(function(i)
                if pickerOpen and i.UserInputType == Enum.UserInputType.MouseButton1 then
                    task.delay(0.02, function()
                        if not Popup:IsDescendantOf(ScreenGui) then return end
                        local mp = UserInputService:GetMouseLocation()
                        local abs = Popup.AbsolutePosition
                        local sz  = Popup.AbsoluteSize
                        if mp.X < abs.X or mp.X > abs.X + sz.X or mp.Y < abs.Y or mp.Y > abs.Y + sz.Y then
                            if not (mp.X >= Swatch.AbsolutePosition.X and mp.X <= Swatch.AbsolutePosition.X + Swatch.AbsoluteSize.X
                                and mp.Y >= Swatch.AbsolutePosition.Y and mp.Y <= Swatch.AbsolutePosition.Y + Swatch.AbsoluteSize.Y) then
                                pickerOpen = false
                                Popup.Visible = false
                            end
                        end
                    end)
                end
            end)

            table.insert(allSearchItems, {
                title  = text,
                kind   = "Colorpicker",
                jumpFn = function() Activate() end
            })

            local ctrl = {}
            function ctrl:Get() return current end
            function ctrl:GetTransparency() return 1 - alpha end
            function ctrl:Set(c)
                current = c
                sliderR.SetValue(c.R)
                sliderG.SetValue(c.G)
                sliderB.SetValue(c.B)
                Swatch.BackgroundColor3         = current
                PreviewSwatch.BackgroundColor3  = current
                if callback then callback(current, 1 - alpha) end
            end
            function ctrl:SetTransparency(t)
                alpha = 1 - math.clamp(t, 0, 1)
                if sliderA then sliderA.SetValue(alpha) end
                UpdateColor()
            end
            return ctrl
        end

        return Tab
    end

    return Window
end

return Library
